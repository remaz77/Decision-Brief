<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Brief</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.5; padding: 20px; }
        .toolbar { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px; padding: 16px 0; margin-bottom: 20px; }
        .toolbar-left, .toolbar-right { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: 1px solid #cbd5e1; background: white; border-radius: 8px; font-family: inherit; font-size: 14px; font-weight: 600; color: #475569; cursor: pointer; transition: all 0.2s ease; }
        .btn:hover { background: #f1f5f9; border-color: #94a3b8; }
        .btn-primary { background: #1e293b; color: white; border-color: #1e293b; }
        .btn-primary:hover { background: #0f172a; border-color: #0f172a; }
        .btn-success { background: #10b981; color: white; border-color: #10b981; }
        .btn-success:hover { background: #059669; border-color: #059669; }
        .btn-info { background: #3b82f6; color: white; border-color: #3b82f6; }
        .btn-info:hover { background: #2563eb; border-color: #2563eb; }
        .btn-warning { background: #f59e0b; color: white; border-color: #f59e0b; }
        .btn-warning:hover { background: #d97706; border-color: #d97706; }
        .btn-email { background: #8b5cf6; color: white; border-color: #8b5cf6; }
        .btn-email:hover { background: #7c3aed; border-color: #7c3aed; }
        .btn-danger { background: #ef4444; color: white; border-color: #ef4444; }
        .btn-danger:hover { background: #dc2626; border-color: #dc2626; }
        .btn-github { background: #333; color: white; border-color: #333; display: flex; align-items: center; gap: 8px; }
        .btn-github:hover { background: #444; border-color: #444; }
        .btn-github.save { background: #238636; border-color: #238636; }
        .btn-github.save:hover { background: #2ea043; border-color: #2ea043; }
        .btn-github.load { background: #1e293b; border-color: #1e293b; }
        .btn-github.load:hover { background: #0f172a; border-color: #0f172a; }
        .btn-github.config { background: #6e40c9; border-color: #6e40c9; }
        .btn-github.config:hover { background: #7c3aed; border-color: #7c3aed; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 20px; font-weight: 700; color: #1e293b; }
        .close-btn { background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .close-btn:hover { background: #f1f5f9; color: #1e293b; }
        .modal-body { margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #475569; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 14px; background: white; transition: all 0.2s ease; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .share-link-container, .pdf-link-container { display: flex; gap: 8px; margin-top: 12px; }
        .share-link-input, .pdf-link-input { flex: 1; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 14px; background: #f8fafc; color: #475569; font-size: 12px; }
        .copy-btn { padding: 10px 16px; background: #1e293b; color: white; border: none; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .copy-btn:hover { background: #0f172a; }
        .copy-btn.copied { background: #10b981; }
        .instructions { margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6; font-size: 13px; color: #475569; }
        .instructions p { margin-bottom: 8px; }
        .instructions ul { padding-left: 20px; margin-bottom: 8px; }
        .email-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .email-template { margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .template-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .template-title { font-size: 14px; font-weight: 600; color: #475569; }
        .template-body { font-size: 12px; color: #64748b; line-height: 1.5; white-space: pre-wrap; }
        .email-options { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .email-option-btn { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s ease; }
        .email-option-btn:hover { background: #f1f5f9; }
        .email-option-btn.active { border-color: #3b82f6; background: #eff6ff; }
        .email-option-btn .title { font-weight: 600; color: #1e293b; margin-bottom: 4px; }
        .email-option-btn .desc { font-size: 12px; color: #64748b; }
        .decision-mandatory .section-title::after { content: " *"; color: #ef4444; font-size: 18px; }
        .decision-mandatory textarea { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .decision-mandatory textarea:focus { border-color: #dc2626 !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.1) !important; }
        .decision-required-warning { display: none; color: #ef4444; font-size: 12px; margin-top: 4px; font-weight: 500; }
        .decision-mandatory .decision-required-warning { display: block; }
        .mandatory-field .section-title::after { content: " *"; color: #ef4444; font-size: 18px; }
        .mandatory-field input, .mandatory-field textarea, .mandatory-field select { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .mandatory-field input:focus, .mandatory-field textarea:focus, .mandatory-field select:focus { border-color: #dc2626 !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.1) !important; }
        .mandatory-warning { display: none; color: #ef4444; font-size: 12px; margin-top: 4px; font-weight: 500; }
        .mandatory-field .mandatory-warning { display: block; }
        .next-steps-mandatory .section-title::after { content: " *"; color: #ef4444; font-size: 18px; }
        .next-steps-mandatory .steps-table input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .next-steps-mandatory .steps-table input:focus { border-color: #dc2626 !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.1) !important; }
        .next-steps-warning { display: none; color: #ef4444; font-size: 12px; margin-top: 10px; font-weight: 500; }
        .next-steps-mandatory .next-steps-warning { display: block; }
        .page { max-width: 1100px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 30px; }
        .page-title { text-align: center; font-size: 32px; font-weight: 800; color: #1e293b; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #1e293b; letter-spacing: -0.5px; }
        .metadata { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .meta-item { display: flex; flex-direction: column; gap: 6px; }
        .meta-label { font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .meta-input { padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 36px; }
        .meta-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .section { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
        .section-title { font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #1e293b; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .section-number { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #1e293b; color: white; border-radius: 6px; font-weight: 700; font-size: 12px; }
        .section-1-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-height: 150px; }
        .section-1-2 > div { display: flex; flex-direction: column; }
        .text-section { flex: 1; display: flex; flex-direction: column; }
        .text-section textarea { flex: 1; min-height: 120px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; line-height: 1.5; resize: vertical; background: white; transition: all 0.2s ease; }
        .text-section textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .options-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .option-card { border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; background: white; display: flex; flex-direction: column; min-height: 240px; }
        .option-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .option-name { font-size: 14px; font-weight: 700; color: #1e293b; }
        .score-display { background: #1e293b; color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 700; min-width: 70px; text-align: center; flex-shrink: 0; }
        .option-input { margin-bottom: 8px; flex-shrink: 0; }
        .option-input input { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 34px; }
        .option-input input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .criteria-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; flex: 1; min-height: 120px; }
        .criteria-table tr:not(:last-child) { border-bottom: 1px solid #e2e8f0; }
        .criteria-table td { padding: 6px 8px; vertical-align: middle; height: 30px; }
        .criteria-label { font-weight: 600; color: #475569; width: 55%; }
        .criteria-score select { width: 100%; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s ease; height: 30px; }
        .criteria-score select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 1px rgba(59,130,246,0.1); }
        .section-4-5 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-height: 150px; }
        .section-4-5 > div { display: flex; flex-direction: column; }
        .supporting-docs { flex: 1; display: flex; flex-direction: column; }
        .documents-list { display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .document-item { display: grid; grid-template-columns: 24px 1fr; gap: 10px; align-items: center; height: 36px; }
        .document-number { width: 22px; height: 22px; background: #64748b; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; flex-shrink: 0; }
        .recommendation-box { flex: 1; display: flex; flex-direction: column; }
        .recommendation-box textarea { flex: 1; min-height: 120px; }
        .steps-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
        .steps-table thead { background: #f1f5f9; }
        .steps-table th { padding: 10px 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0; font-size: 12px; }
        .steps-table td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; height: 40px; }
        .steps-table input { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 34px; }
        .steps-table input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .decision-section { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
        .decision-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .decision-title { font-size: 16px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .decision-date-container { display: flex; align-items: center; gap: 8px; }
        .decision-date-label { font-size: 13px; font-weight: 600; color: #475569; }
        .decision-date-input { padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 36px; min-width: 150px; }
        .decision-date-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .decision-options { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .decision-option { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .decision-option input[type="radio"] { width: 16px; height: 16px; cursor: pointer; }
        .decision-option label { font-size: 13px; font-weight: 500; color: #475569; cursor: pointer; }
        .decision-option input[type="radio"]:checked + label { color: #1e293b; font-weight: 600; }
        .decision-notes { min-height: 100px; }
        .decision-notes textarea { height: 100%; min-height: 80px; width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; line-height: 1.5; resize: vertical; background: white; transition: all 0.2s ease; }
        .decision-notes textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b; text-align: center; }
        .status-indicator { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 600; margin-left: 10px; background: #e2e8f0; color: #475569; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-conditional { background: #dbeafe; color: #1e40af; }
        .status-promoted { background: #ddd6fe; color: #5b21b6; }
        .dashboard-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .dashboard-table thead { background: #f1f5f9; }
        .dashboard-table th { padding: 10px 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0; font-size: 12px; }
        .dashboard-table td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; }
        .dashboard-table tr:hover { background: #f8fafc; }
        .password-input-group { position: relative; }
        .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #64748b; cursor: pointer; }
        .export-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .github-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 600; margin-left: 10px; background: #e2e8f0; color: #475569; }
        .status-connected { background: #d1fae5; color: #065f46; }
        .status-disconnected { background: #fee2e2; color: #991b1b; }
        .token-input { font-family: monospace; font-size: 13px; }
        .btn-cloud-save { background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%); color: white; border: none; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
        .btn-cloud-save:hover { background: linear-gradient(135deg, #059669 0%, #2563eb 100%); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .btn-cloud-save:disabled { background: #94a3b8; cursor: not-allowed; box-shadow: none; }
        .btn-outlook { background: #0072C6; color: white; border-color: #0072C6; }
        .btn-outlook:hover { background: #005A9E; border-color: #005A9E; }
        .step-indicator { display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; background: #3b82f6; color: white; border-radius: 50%; font-weight: bold; margin-right: 10px; }
        .step-container { display: flex; align-items: center; margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .step-content { flex: 1; }
        .section-disabled { opacity: 0.6; pointer-events: none; background: #f1f5f9; }
        .section-disabled textarea, .section-disabled input, .section-disabled select { background: #e2e8f0; cursor: not-allowed; }
        .manager-only { display: none; }
        .manager-mode .manager-only { display: block; }
        .manager-mode .requester-only { display: none; }
        .scoring-note { font-size: 12px; color: #64748b; margin-left: 10px; font-weight: normal; background: #e2e8f0; padding: 2px 8px; border-radius: 12px; }
        .bottom-save { display: flex; justify-content: center; margin: 20px 0; }
        @media (max-width: 1024px) {
            .metadata { grid-template-columns: repeat(2, 1fr); }
            .options-grid { grid-template-columns: repeat(2, 1fr); }
            .section-1-2, .section-4-5 { grid-template-columns: 1fr; gap: 15px; }
            .decision-header { flex-direction: column; align-items: flex-start; }
        }
        @media (max-width: 768px) {
            .page { padding: 20px; }
            .toolbar { flex-direction: column; }
            .toolbar-left, .toolbar-right { width: 100%; justify-content: space-between; }
            .options-grid { grid-template-columns: 1fr; }
            .decision-options { flex-direction: column; gap: 12px; }
            .metadata { grid-template-columns: 1fr; }
            .email-actions { flex-direction: column; }
            .email-options { flex-direction: column; }
            .dashboard-table { display: block; overflow-x: auto; }
        }
        @media print {
            body { background: white; padding: 0; }
            .toolbar { display: none; }
            .modal { display: none !important; }
            .page { box-shadow: none; border-radius: 0; padding: 20px; max-width: 100%; }
            .option-card { break-inside: avoid; page-break-inside: avoid; }
            .meta-input, .option-input input, .steps-table input, textarea, select { border: 1px solid #ccc !important; background: white !important; }
            .decision-mandatory textarea, .mandatory-field input, .mandatory-field textarea { border: 1px solid #ccc !important; background: white !important; }
        }
    </style>
</head>
<body>

<!-- GitHub Configuration Modal -->
<div id="githubConfigModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><i class="fab fa-github"></i> Free Cloud Sync Setup</div>
            <button class="close-btn" onclick="closeGithubConfig()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <h4><i class="fas fa-cloud"></i> Sync with GitHub (100% Free)</h4>
                <p style="margin-bottom: 15px; color: #666;">Store your Decision Brief data on GitHub Gists. All devices can sync automatically.</p>
            </div>
            <div class="form-group">
                <label class="form-label">GitHub Personal Access Token *</label>
                <input type="password" id="githubToken" class="form-input token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666;">Get token from: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a><br>Select only: <code>gist</code> scope</small>
            </div>
            <div class="form-group">
                <label class="form-label">Gist ID (Optional)</label>
                <input type="text" id="gistId" class="form-input token-input" placeholder="Leave empty to create new">
                <small style="color: #666;">If sharing with team, use same Gist ID on all devices</small>
            </div>
            <div class="form-group">
                <label class="form-label">Auto Save</label>
                <select id="syncFrequency" class="form-input">
                    <option value="manual">Manual Only</option>
                    <option value="5">Every 5 minutes</option>
                    <option value="15">Every 15 minutes</option>
                    <option value="60">Every hour</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="saveGithubConfig()" style="width: 100%; margin-top: 15px;"><i class="fas fa-save"></i> Save Configuration</button>
            <div id="configStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            <div class="instructions">
                <h4><i class="fas fa-question-circle"></i> Simple 3-Step Setup:</h4>
                <ol style="margin-left: 20px; color: #555;">
                    <li>Go to <a href="https://github.com/settings/tokens" target="_blank">GitHub Tokens</a></li>
                    <li>Click "Generate new token" ‚Üí "Generate new token (classic)"</li>
                    <li>Name: "Decision Brief Sync"</li>
                    <li>Expiration: 90 days (recommended)</li>
                    <li>Select ONLY: <strong>gist</strong> scope ‚úì</li>
                    <li>Click "Generate token"</li>
                    <li>Copy token (starts with ghp_)</li>
                    <li>Paste above and save</li>
                </ol>
                <p style="margin-top: 10px; font-size: 12px; color: #777;"><i class="fas fa-shield-alt"></i> Token stored locally only. 100% free forever.</p>
            </div>
        </div>
    </div>
</div>

<!-- Save Success Modal (simplified) -->
<div id="saveSuccessModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-title" style="color: #10b981;"><i class="fas fa-check-circle"></i> Successfully Saved to Cloud!</div>
            <button class="close-btn" onclick="closeSaveSuccessModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="instructions" style="background: #d1fae5; border-left-color: #10b981; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-cloud" style="font-size: 24px; color: #059669;"></i>
                    <div>
                        <h4 style="margin: 0; color: #065f46;">‚úÖ Document Saved to Cloud</h4>
                        <p style="margin: 5px 0 0 0; color: #047857; font-size: 13px;">Document ID: <code id="successDocId">Loading...</code></p>
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" style="font-size: 14px; color: #1e293b;"><i class="fas fa-link"></i> Shareable Link</label>
                <div class="share-link-container">
                    <input type="text" class="share-link-input" id="successShareLink" value="" readonly>
                    <button class="copy-btn" onclick="copySuccessShareLink()">Copy Link</button>
                </div>
            </div>
            <div class="email-actions" style="justify-content: center; margin-top: 20px;">
                <button class="btn btn-warning" onclick="shareLinkViaEmailFromSuccess()" style="padding: 12px 30px;">
                    <i class="fas fa-envelope"></i> Share via Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manager Save Success Modal (simplified) -->
<div id="managerSaveSuccessModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <div class="modal-title" style="color: #10b981;"><i class="fas fa-check-circle"></i> Decision Saved to Cloud!</div>
            <button class="close-btn" onclick="closeManagerSaveSuccessModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="instructions" style="background: #d1fae5; border-left-color: #10b981; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-cloud" style="font-size: 24px; color: #059669;"></i>
                    <div>
                        <h4 style="margin: 0; color: #065f46;">‚úÖ Decision Saved</h4>
                        <p style="margin: 5px 0 0 0; color: #047857; font-size: 13px;">Document ID: <code id="managerSuccessDocId">Loading...</code></p>
                    </div>
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" style="font-size: 14px; color: #1e293b;"><i class="fas fa-link"></i> Updated Document Link</label>
                <div class="share-link-container">
                    <input type="text" class="share-link-input" id="managerSuccessShareLink" value="" readonly>
                    <button class="copy-btn" onclick="copyManagerSuccessShareLink()">Copy Link</button>
                </div>
            </div>
            <div class="email-actions" style="justify-content: center; margin-top: 20px;">
                <button class="btn btn-warning" onclick="shareLinkViaEmailFromManagerSuccess()" style="padding: 12px 30px;">
                    <i class="fas fa-envelope"></i> Share via Email
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Email Modal (modified: only Open Outlook button) -->
<div id="emailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="emailModalTitle">Create Email for Decision Brief</div>
            <button class="close-btn" id="closeEmailModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label" id="toLabel">To (Recipient Email)</label>
                <input type="email" class="form-input" id="toEmail" placeholder="email@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Your Email (Optional)</label>
                <input type="email" class="form-input" id="fromEmail" placeholder="your.email@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Subject</label>
                <input type="text" class="form-input" id="emailSubject" placeholder="Decision Brief">
            </div>
            <div class="form-group">
                <label class="form-label">Additional Message (Optional)</label>
                <textarea class="form-input form-textarea" id="additionalMessage" rows="3" placeholder="Add any additional comments or instructions..."></textarea>
            </div>
            <div class="email-template">
                <div class="template-header">
                    <div class="template-title" id="templateTitle">HTML Email Template:</div>
                    <button class="btn btn-sm" onclick="useTemplate()">Refresh Template</button>
                </div>
                <div class="template-body" id="emailTemplatePreview" style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></div>
            </div>
            <div class="email-actions" id="emailModalActions">
                <!-- Only one button will be inserted here -->
            </div>
            <div class="instructions">
                <p><strong>How to send:</strong></p>
                <ul id="emailInstructions">
                    <li><strong>Open Outlook</strong> - Opens your default email client with the email pre-filled</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- PDF Download Modal -->
<div id="pdfModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">PDF Ready for Download</div>
            <button class="close-btn" id="closePdfModal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Your Decision Brief PDF has been generated successfully.</p>
            <div class="email-actions" style="margin: 20px 0;">
                <button class="btn btn-success" id="downloadPdfBtn" style="width: 100%; padding: 15px; font-size: 16px;">
                    <i class="fas fa-download"></i> Download PDF File
                </button>
            </div>
            <div class="instructions">
                <p><strong>How to share:</strong></p>
                <ul>
                    <li><strong>Download PDF</strong> - Save the PDF to your computer</li>
                    <li><strong>Attach to Email</strong> - Manually attach to any email</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Toolbar (Save button moved to bottom) -->
<div class="toolbar">
    <div class="toolbar-left">
        <button class="btn" onclick="resetForm()">Reset Form</button>
        <button class="btn btn-info" onclick="openDashboard()" title="Manage all documents"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
        <button class="btn btn-github config" onclick="showGithubConfigModal()" title="GitHub Cloud Settings"><i class="fab fa-github"></i> <i class="fas fa-cog"></i></button>
    </div>
    <div class="toolbar-right">
        <button class="btn btn-github load" onclick="loadFromGithub()" id="loadFromGithubBtn" title="Load from GitHub Cloud"><i class="fab fa-github"></i> Load from Cloud</button>
        <button class="btn btn-email" id="shareViaEmailBtn" onclick="openShareViaEmail()" title="Share document via email"><i class="fas fa-envelope"></i> Share via Email</button>
        <button class="btn btn-primary" onclick="generatePDF()" id="generatePdfBtn" title="Please make a decision and add notes first">Generate PDF</button>
        <button class="btn" onclick="window.print()">Print</button>
    </div>
</div>

<!-- Main Page -->
<div class="page" id="contentToPrint">
    <h1 class="page-title">
        Decision Brief 
        <span id="statusBadge" class="status-indicator">Draft</span>
        <span id="githubStatus" class="github-status status-disconnected" style="display: none;"><i class="fas fa-cloud"></i> Cloud: Not Setup</span>
    </h1>

    <!-- Metadata Section -->
    <div class="metadata">
        <div class="meta-item mandatory-field" id="topicField">
            <div class="meta-label">Topic</div>
            <input type="text" class="meta-input" id="topic" placeholder="Enter decision topic">
            <div class="mandatory-warning">* Required</div>
        </div>
        <div class="meta-item mandatory-field" id="requesterField">
            <div class="meta-label">Requested by</div>
            <input type="text" class="meta-input" id="requestedBy" placeholder="Name of requester">
            <div class="mandatory-warning">* Required</div>
        </div>
        <div class="meta-item mandatory-field" id="ownerField">
            <div class="meta-label">Decision Owner</div>
            <input type="text" class="meta-input" id="decisionOwner" placeholder="Name of decision maker">
            <div class="mandatory-warning">* Required</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Request Date</div>
            <input type="date" class="meta-input" id="requestDate">
        </div>
        <div class="meta-item" id="requesterEmailField">
            <div class="meta-label">Requester Email</div>
            <input type="email" class="meta-input" id="requesterEmail" placeholder="requester@company.com">
        </div>
        <div class="meta-item" id="decisionOwnerEmailField">
            <div class="meta-label">Decision Owner Email</div>
            <input type="email" class="meta-input" id="decisionOwnerEmail" placeholder="manager@company.com">
        </div>
    </div>

    <!-- SECTION 1 & 2 -->
    <div class="section section-1-2">
        <div class="mandatory-field" id="backgroundField">
            <div class="section-title"><span class="section-number">1</span> Background &amp; Requirement</div>
            <div class="text-section">
                <textarea id="background" placeholder="Describe the context, problem statement, and business need..."></textarea>
                <div class="mandatory-warning">* Required</div>
            </div>
        </div>
        <div class="mandatory-field" id="decisionRequiredField">
            <div class="section-title"><span class="section-number">2</span> Decision Required</div>
            <div class="text-section">
                <textarea id="decisionRequired" placeholder="Clearly state the specific decision that needs to be made..."></textarea>
                <div class="mandatory-warning">* Required</div>
            </div>
        </div>
    </div>

    <!-- SECTION 3 (modified: criteria labels, placeholder "Topic", no default values) -->
    <div class="section">
        <div class="section-title">
            <span class="section-number">3</span> Options Considered
            <span class="scoring-note">5=best, 4,3=average, 1,2=worst</span>
        </div>
        <div class="options-grid" id="optionsGrid"></div>
    </div>

    <!-- SECTION 4 & 5 -->
    <div class="section section-4-5">
        <div>
            <div class="section-title"><span class="section-number">4</span> Supporting Documents</div>
            <div class="supporting-docs">
                <div class="documents-list" id="documentsList">
                    <div class="document-item"><div class="document-number">1</div><input type="text" class="meta-input document-input" placeholder="Document name or link"></div>
                    <div class="document-item"><div class="document-number">2</div><input type="text" class="meta-input document-input" placeholder="Document name or link"></div>
                    <div class="document-item"><div class="document-number">3</div><input type="text" class="meta-input document-input" placeholder="Document name or link"></div>
                </div>
            </div>
        </div>
        <div class="mandatory-field" id="recommendationField">
            <div class="section-title"><span class="section-number">5</span> Recommendation</div>
            <div class="text-section recommendation-box">
                <textarea id="recommendation" placeholder="Provide a clear recommendation with supporting rationale..."></textarea>
                <div class="mandatory-warning">* Required</div>
            </div>
        </div>
    </div>

    <!-- SECTION 6: Next Steps -->
    <div class="section" id="nextStepsSection">
        <div class="section-title"><span class="section-number">6</span> Next Steps (if approved)</div>
        <table class="steps-table">
            <thead><tr><th>Action</th><th>Responsible</th><th>Timeline</th></tr></thead>
            <tbody id="stepsTableBody">
                <tr><td><input type="text" class="step-action" placeholder="Describe specific action"></td><td><input type="text" class="step-responsible" placeholder="Name or role"></td><td><input type="text" class="step-timeline" placeholder="Date or timeframe"></td></tr>
                <tr><td><input type="text" class="step-action" placeholder="Describe specific action"></td><td><input type="text" class="step-responsible" placeholder="Name or role"></td><td><input type="text" class="step-timeline" placeholder="Date or timeframe"></td></tr>
                <tr><td><input type="text" class="step-action" placeholder="Describe specific action"></td><td><input type="text" class="step-responsible" placeholder="Name or role"></td><td><input type="text" class="step-timeline" placeholder="Date or timeframe"></td></tr>
            </tbody>
        </table>
        <div class="next-steps-warning">* At least one next step is required</div>
    </div>

    <!-- SECTION 7: Decision -->
    <div class="decision-section section-disabled" id="decisionSection">
        <div class="decision-header">
            <div class="decision-title"><span class="section-number">7</span> Decision <span class="status-indicator status-pending" id="decisionStatusLabel">Awaiting Manager</span></div>
            <div class="decision-date-container"><div class="decision-date-label">Decision Date:</div><input type="date" class="decision-date-input" id="decisionDate" disabled></div>
        </div>
        <div class="decision-options">
            <div class="decision-option"><input type="radio" id="approved" name="decision" value="approved" disabled><label for="approved">Approved</label></div>
            <div class="decision-option"><input type="radio" id="approved-conditions" name="decision" value="approved-conditions" disabled><label for="approved-conditions">Approved with conditions</label></div>
            <div class="decision-option"><input type="radio" id="not-approved" name="decision" value="not-approved" disabled><label for="not-approved">Not approved</label></div>
            <div class="decision-option"><input type="radio" id="requester-promoted" name="decision" value="requester-promoted" disabled><label for="requester-promoted">Requester promoted to decide</label></div>
        </div>
        <div class="decision-notes"><textarea id="decisionNotes" placeholder="Decision notes, conditions, or rationale... (Manager must provide decision and notes)" disabled></textarea><div class="decision-required-warning">* Manager must provide decision and notes</div></div>
        <div class="instructions" style="margin-top: 10px;"><p><i class="fas fa-lock"></i> <strong>Section Locked:</strong> Only the Decision Owner (Manager) can update this section after the document is saved to cloud.</p></div>
    </div>

    <!-- Bottom Save Button -->
    <div class="bottom-save">
        <button class="btn btn-cloud-save" onclick="saveToCloudAndShare()" id="saveAndShareBtn" style="font-size: 16px; padding: 12px 40px;">
            <i class="fas fa-cloud-upload-alt"></i> Save to Cloud and Share
        </button>
    </div>

    <div class="footer">
        Document ID: <span id="docId">Draft</span> | Generated on <span id="generatedDate"></span>
    </div>
</div>

<!-- First Time Help Modal (hidden) -->
<div id="firstTimeHelpModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-title" style="color: #3b82f6;"><i class="fas fa-rocket"></i> Welcome to Decision Brief!</div>
            <button class="close-btn" onclick="closeFirstTimeHelp()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; color: #3b82f6; margin-bottom: 10px;">üìã</div>
                <h3 style="color: #1e293b; margin-bottom: 10px;">Professional Decision Documentation Made Easy</h3>
                <p style="color: #64748b;">Follow these simple steps to get started</p>
            </div>
            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <div style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;">1Ô∏è‚É£</div>
                        <h4 style="margin: 0 0 5px 0; color: #0369a1;">Fill Form</h4>
                        <p style="font-size: 12px; color: #475569; margin: 0;">Complete the decision brief</p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef3c7; border-radius: 8px;">
                        <div style="font-size: 24px; color: #f59e0b; margin-bottom: 10px;">2Ô∏è‚É£</div>
                        <h4 style="margin: 0 0 5px 0; color: #92400e;">Save to Cloud</h4>
                        <p style="font-size: 12px; color: #475569; margin: 0;">Click "Save to Cloud and Share"</p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #d1fae5; border-radius: 8px;">
                        <div style="font-size: 24px; color: #10b981; margin-bottom: 10px;">3Ô∏è‚É£</div>
                        <h4 style="margin: 0 0 5px 0; color: #065f46;">Share with Manager</h4>
                        <p style="font-size: 12px; color: #475569; margin: 0;">Email link from success modal</p>
                    </div>
                </div>
            </div>
            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h4 style="color: #475569; margin-bottom: 10px;"><i class="fas fa-lightbulb"></i> How It Works:</h4>
                <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                    <li><strong>Requester:</strong> Fill Sections 1-6 ‚Üí Save ‚Üí Email to Manager</li>
                    <li><strong>Section 7:</strong> Locked for requester, only manager can update</li>
                    <li><strong>Manager:</strong> Receives link ‚Üí Updates Section 7 ‚Üí Saves ‚Üí Emails back to requester</li>
                    <li><strong>Cloud Storage:</strong> FREE GitHub Gists (100% private to your account)</li>
                </ul>
            </div>
            <div class="email-actions" style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="closeFirstTimeHelp()" style="padding: 12px 30px;"><i class="fas fa-play-circle"></i> Let's Get Started!</button>
                <button class="btn" onclick="showGithubConfigModal(); closeFirstTimeHelp();" style="margin-left: 10px;"><i class="fab fa-github"></i> Setup Cloud First</button>
            </div>
            <p style="text-align: center; margin-top: 15px; color: #94a3b8; font-size: 12px;"><i class="fas fa-info-circle"></i> This message won't show again</p>
        </div>
    </div>
</div>

<script>
    // ================================
    // üîó GITHUB GIST CONFIGURATION
    // ================================
    const GITHUB_CONFIG_KEY = 'decision_brief_github_config';
    const DOCUMENTS_DB_KEY = 'decision_brief_documents';
    const DASHBOARD_PASSWORD_KEY = 'decision_brief_dashboard_password';
    const USER_ROLE_KEY = 'decision_brief_user_role';
    const TEMPLATE_URL = window.location.href.split('#')[0];

    let githubConfig = {
        token: '',
        gistId: '',
        syncFrequency: 'manual',
        lastSync: null
    };
    
    let documentsDatabase = [];
    let dashboardPassword = null;
    let syncInterval = null;
    
    let currentPdfBlob = null;
    let currentPdfUrl = null;
    let documentUniqueId = null;
    let currentFormData = null;
    let htmlEmailTemplate = '';
    let plainTextTemplate = '';
    
    let documentSaved = false;
    let section7Filled = false;
    let currentEmailType = 'manager';
    let isManagerMode = false;
    let currentUserRole = 'requester';
    let isDocumentLoadedFromURL = false;

    document.addEventListener("DOMContentLoaded", function () {
        loadGithubConfig();
        loadDocumentsDatabase();
        initializeDocument();
        setupPdfModalListeners();
        setupEmailModalListeners();
        setTimeout(() => { loadDocumentFromURL(); }, 500);
        applyUserRole();
        localStorage.setItem('decision_brief_help_seen', 'true');
    });

    function updateUIForRole() {
        const shareViaEmailBtn = document.getElementById('shareViaEmailBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        
        if (isManagerMode) {
            shareViaEmailBtn.innerHTML = '<i class="fas fa-envelope"></i> Email to Requester';
            shareViaEmailBtn.title = 'Email decision to requester';
        } else {
            shareViaEmailBtn.innerHTML = '<i class="fas fa-envelope"></i> Email to Manager';
            shareViaEmailBtn.title = 'Email document to manager for review';
        }
        
        checkDecisionMade();
        
        if (documentSaved) {
            shareViaEmailBtn.style.display = 'inline-block';
        } else {
            shareViaEmailBtn.style.display = 'none';
        }
    }

    function detectUserRole() {
        const urlParams = new URLSearchParams(window.location.search);
        const roleParam = urlParams.get('role');
        if (roleParam === 'manager') return 'manager';
        if (roleParam === 'requester') return 'requester';
        
        const hash = window.location.hash;
        const hasDocumentId = hash.includes('doc=');
        if (hasDocumentId) {
            const decisionSelected = document.querySelector('input[name="decision"]:checked');
            const decisionNotes = document.getElementById("decisionNotes").value.trim();
            const isDecisionMade = decisionSelected && decisionNotes.length > 0;
            return isDecisionMade ? 'requester' : 'manager';
        }
        return 'requester';
    }

    function applyUserRole() {
        const detectedRole = detectUserRole();
        currentUserRole = detectedRole;
        localStorage.setItem(USER_ROLE_KEY, currentUserRole);
        
        if (currentUserRole === 'manager') {
            enableManagerMode();
        } else {
            enableRequesterMode();
        }
        
        updateUIForRole();
    }

    function enableManagerMode() {
        isManagerMode = true;
        const decisionSection = document.getElementById('decisionSection');
        decisionSection.classList.remove('section-disabled');
        decisionSection.querySelectorAll('input, textarea, select').forEach(el => { el.disabled = false; });
        document.getElementById('decisionStatusLabel').textContent = 'Manager Mode';
        document.getElementById('decisionStatusLabel').className = 'status-indicator status-approved';
        const instructions = document.querySelector('#decisionSection .instructions');
        if (instructions) {
            instructions.innerHTML = '<p><i class="fas fa-unlock"></i> <strong>Manager Mode:</strong> You can update the decision and notes. After saving, use "Share via Email" to send the decision to the requester.</p>';
        }
    }

    function enableRequesterMode() {
        isManagerMode = false;
        const decisionSection = document.getElementById('decisionSection');
        decisionSection.classList.add('section-disabled');
        decisionSection.querySelectorAll('input, textarea, select').forEach(el => { el.disabled = true; });
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        const decisionNotes = document.getElementById("decisionNotes").value.trim();
        if (decisionSelected && decisionNotes.length > 0) {
            updateStatusBadge();
        } else {
            document.getElementById('decisionStatusLabel').textContent = 'Awaiting Manager';
            document.getElementById('decisionStatusLabel').className = 'status-indicator status-pending';
        }
        const instructions = document.querySelector('#decisionSection .instructions');
        if (instructions) {
            instructions.innerHTML = '<p><i class="fas fa-lock"></i> <strong>Section Locked:</strong> Only the Decision Owner (Manager) can update this section after the document is saved to cloud.</p>';
        }
    }

    function initializeDocument() {
        document.getElementById("generatedDate").textContent = new Date().toLocaleDateString("en-US", {
            year: "numeric", month: "long", day: "numeric"
        });
        document.getElementById("requestDate").valueAsDate = new Date();
        document.getElementById("decisionDate").valueAsDate = new Date();
        generateDocumentId();
        createOptionsGrid(); // updated
        initializeScores();
        setupEventListeners();
        updateStatusBadge();
    }

    function generateDocumentId() {
        documentUniqueId = `DB-${Date.now()}-${Math.floor(Math.random()*1000)}`;
        document.getElementById("docId").textContent = documentUniqueId;
    }

    // MODIFIED: createOptionsGrid with new criteria labels, placeholder "Topic", no default values
    function createOptionsGrid() {
        const optionsGrid = document.getElementById("optionsGrid");
        const criteria = [
            { name: "Cost Saving", key: "Cost" },
            { name: "Time Efficiency", key: "Time" },
            { name: "Risk Severity", key: "Risk" },
            { name: "People", key: "People" },
            { name: "Compliance", key: "Compliance" }
        ];
        const optionPlaceholders = [ "", "", "" ]; // no default values
        optionsGrid.innerHTML = '';
        optionPlaceholders.forEach((placeholder, idx) => {
            const card = document.createElement("div");
            card.className = "option-card";
            card.dataset.optionIndex = idx;
            let criteriaHTML = "";
            criteria.forEach(crit => {
                criteriaHTML += `<tr><td class="criteria-label">${crit.name}</td><td class="criteria-score"><select class="score-select"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></td></tr>`;
            });
            card.innerHTML = `
                <div class="option-header">
                    <div class="option-name">Option ${String.fromCharCode(65+idx)}</div>
                    <div class="score-display">Score: <span class="score-value">0</span></div>
                </div>
                <div class="option-input">
                    <input type="text" class="option-title" data-field="title" value="" placeholder="Topic">
                </div>
                <div class="option-input">
                    <input type="text" class="option-description" data-field="description" value="" placeholder="Brief description">
                </div>
                <table class="criteria-table"><tbody>${criteriaHTML}</tbody></table>
            `;
            optionsGrid.appendChild(card);
        });
    }

    function calculateScore(optionCard) {
        const selects = optionCard.querySelectorAll(".score-select");
        let total = 0;
        selects.forEach(sel => { total += parseInt(sel.value) || 0; });
        const scoreSpan = optionCard.querySelector(".score-value");
        scoreSpan.textContent = total;
        const display = optionCard.querySelector(".score-display");
        if (total >= 21) display.style.background = "#10b981";
        else if (total >= 11) display.style.background = "#f59e0b";
        else display.style.background = "#ef4444";
        return total;
    }

    function initializeScores() {
        document.querySelectorAll(".option-card").forEach(card => {
            calculateScore(card);
            card.querySelectorAll(".score-select").forEach(sel => {
                sel.addEventListener("change", () => calculateScore(card));
            });
        });
    }

    function setupEventListeners() {
        document.querySelectorAll('input[name="decision"]').forEach(radio => {
            radio.addEventListener("change", function () { updateStatusBadge(); checkDecisionMade(); });
        });
        document.getElementById("decisionNotes").addEventListener("input", checkDecisionMade);
        document.getElementById("decisionDate").addEventListener("change", updateStatusBadge);
        const mandatoryFields = ["topic", "requestedBy", "decisionOwner", "background", "decisionRequired", "recommendation"];
        mandatoryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field) return;
            field.addEventListener("input", () => validateMandatoryField(fieldId));
            field.addEventListener("blur", () => validateMandatoryField(fieldId));
        });
        document.querySelectorAll(".step-action, .step-responsible, .step-timeline").forEach(input => {
            input.addEventListener("input", validateNextSteps);
            input.addEventListener("blur", validateNextSteps);
        });
        window.addEventListener("click", e => {
            if (e.target === document.getElementById('githubConfigModal')) closeGithubConfig();
        });
        window.addEventListener("click", e => {
            if (e.target === document.getElementById('firstTimeHelpModal')) closeFirstTimeHelp();
        });
    }

    function validateMandatoryField(fieldId) {
        const field = document.getElementById(fieldId);
        const fieldContainer = document.getElementById(fieldId + "Field");
        if (!field || !fieldContainer) return;
        if (!field.value.trim()) fieldContainer.classList.add("mandatory-field");
        else fieldContainer.classList.remove("mandatory-field");
    }

    function validateNextSteps() {
        const stepActions = document.querySelectorAll(".step-action");
        const stepResponsibles = document.querySelectorAll(".step-responsible");
        const stepTimelines = document.querySelectorAll(".step-timeline");
        const nextStepsSection = document.getElementById("nextStepsSection");
        let hasAtLeastOneStep = false;
        for (let i = 0; i < stepActions.length; i++) {
            if (stepActions[i].value.trim() || stepResponsibles[i].value.trim() || stepTimelines[i].value.trim()) {
                hasAtLeastOneStep = true; break;
            }
        }
        if (!hasAtLeastOneStep) nextStepsSection.classList.add("next-steps-mandatory");
        else nextStepsSection.classList.remove("next-steps-mandatory");
        return hasAtLeastOneStep;
    }

    function validateAllMandatoryFields() {
        const mandatoryFields = ["topic", "requestedBy", "decisionOwner", "background", "decisionRequired", "recommendation"];
        let isValid = true;
        mandatoryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const fieldContainer = document.getElementById(fieldId + "Field");
            if (field && fieldContainer) {
                if (!field.value.trim()) {
                    fieldContainer.classList.add("mandatory-field");
                    isValid = false;
                } else {
                    fieldContainer.classList.remove("mandatory-field");
                }
            }
        });
        if (!validateNextSteps()) isValid = false;
        return isValid;
    }

    function checkSection7Complete() {
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        const decisionNotes = document.getElementById("decisionNotes").value.trim();
        return decisionSelected && decisionNotes.length > 0;
    }

    function checkDecisionMade() {
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        const decisionNotes = document.getElementById("decisionNotes").value.trim();
        const decisionMade = decisionSelected && decisionNotes.length > 0;
        const pdfBtn = document.getElementById("generatePdfBtn");
        if (isManagerMode && decisionMade) {
            pdfBtn.disabled = false;
            pdfBtn.title = "Generate PDF document";
        } else if (!isManagerMode) {
            pdfBtn.disabled = true;
            pdfBtn.title = "Only manager can generate PDF after making decision";
        } else {
            pdfBtn.disabled = true;
            pdfBtn.title = "Please make a decision and add notes first";
        }
        return decisionMade;
    }

    function updateStatusBadge() {
        const statusBadge = document.getElementById("statusBadge");
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        if (!decisionSelected) {
            statusBadge.textContent = "Draft";
            statusBadge.className = "status-indicator";
            return;
        }
        switch (decisionSelected.value) {
            case "approved":
                statusBadge.textContent = "Approved";
                statusBadge.className = "status-indicator status-approved";
                break;
            case "approved-conditions":
                statusBadge.textContent = "Approved with Conditions";
                statusBadge.className = "status-indicator status-conditional";
                break;
            case "not-approved":
                statusBadge.textContent = "Not Approved";
                statusBadge.className = "status-indicator status-rejected";
                break;
            case "requester-promoted":
                statusBadge.textContent = "Requester to Decide";
                statusBadge.className = "status-indicator status-promoted";
                break;
            default:
                statusBadge.textContent = "Draft";
                statusBadge.className = "status-indicator";
        }
    }

    function resetForm() {
        if (!confirm("Reset all fields?")) return;
        document.querySelectorAll("input[type='text'], input[type='email'], textarea").forEach(el => el.value = "");
        document.querySelectorAll("input[type='radio'][name='decision']").forEach(r => r.checked = false);
        document.getElementById("requestDate").valueAsDate = new Date();
        document.getElementById("decisionDate").valueAsDate = new Date();
        documentUniqueId = null;
        generateDocumentId();
        document.getElementById("nextStepsSection").classList.remove("next-steps-mandatory");
        const mandatoryFields = ["topic", "requestedBy", "decisionOwner", "background", "decisionRequired", "recommendation"];
        mandatoryFields.forEach(fieldId => {
            const fieldContainer = document.getElementById(fieldId + "Field");
            if (fieldContainer) fieldContainer.classList.remove("mandatory-field");
        });
        document.querySelectorAll(".score-select").forEach(select => { select.value = "0"; });
        document.querySelectorAll(".option-card").forEach(card => calculateScore(card));
        documentSaved = false;
        isDocumentLoadedFromURL = false;
        enableRequesterMode();
        updateStatusBadge();
        checkDecisionMade();
        updateUIForRole();
    }

    function collectFormData() {
        const data = {};
        data.Topic = document.getElementById("topic").value;
        data.RequestedBy = document.getElementById("requestedBy").value;
        data.DecisionOwner = document.getElementById("decisionOwner").value;
        data.RequesterEmail = document.getElementById("requesterEmail").value || "";
        data.DecisionOwnerEmail = document.getElementById("decisionOwnerEmail").value || "";
        data.RequestDate = document.getElementById("requestDate").value;
        data.DecisionDate = document.getElementById("decisionDate").value;
        data.Background = document.getElementById("background").value;
        data.DecisionRequired = document.getElementById("decisionRequired").value;
        data.Options = [];
        document.querySelectorAll(".option-card").forEach(card => {
            const option = {
                Title: card.querySelector(".option-title").value,
                Description: card.querySelector(".option-description").value,
                Scores: []
            };
            const criteria = ["Cost Saving", "Time Efficiency", "Risk Severity", "People", "Compliance"];
            card.querySelectorAll(".score-select").forEach((select, idx) => {
                option.Scores.push({ Criterion: criteria[idx], Score: parseInt(select.value) || 0 });
            });
            data.Options.push(option);
        });
        data.Documents = [];
        document.querySelectorAll(".document-input").forEach(input => {
            if (input.value.trim()) data.Documents.push(input.value.trim());
        });
        data.Recommendation = document.getElementById("recommendation").value;
        data.NextSteps = [];
        const stepActions = document.querySelectorAll(".step-action");
        const stepResponsibles = document.querySelectorAll(".step-responsible");
        const stepTimelines = document.querySelectorAll(".step-timeline");
        for (let i = 0; i < stepActions.length; i++) {
            if (stepActions[i].value.trim() || stepResponsibles[i].value.trim() || stepTimelines[i].value.trim()) {
                data.NextSteps.push({ Action: stepActions[i].value, Responsible: stepResponsibles[i].value, Timeline: stepTimelines[i].value });
            }
        }
        const selectedDecision = document.querySelector('input[name="decision"]:checked');
        data.Decision = selectedDecision ? selectedDecision.value : "";
        data.DecisionNotes = document.getElementById("decisionNotes").value;
        data.DocId = document.getElementById("docId").textContent;
        data.GeneratedDate = document.getElementById("generatedDate").textContent;
        data.DecisionStatusText = (function () {
            if (!selectedDecision) return "Pending";
            switch (selectedDecision.value) {
                case "approved": return "Approved";
                case "approved-conditions": return "Approved with conditions";
                case "not-approved": return "Not approved";
                case "requester-promoted": return "Requester to decide";
                default: return selectedDecision.value;
            }
        })();
        data.UserRole = currentUserRole;
        data.IsManagerMode = isManagerMode;
        return data;
    }

    function populateForm(data) {
        if (!data) return;
        if (data.Topic) document.getElementById("topic").value = data.Topic;
        if (data.RequestedBy) document.getElementById("requestedBy").value = data.RequestedBy;
        if (data.DecisionOwner) document.getElementById("decisionOwner").value = data.DecisionOwner;
        if (data.RequesterEmail) document.getElementById("requesterEmail").value = data.RequesterEmail;
        if (data.DecisionOwnerEmail) document.getElementById("decisionOwnerEmail").value = data.DecisionOwnerEmail;
        if (data.RequestDate) document.getElementById("requestDate").value = data.RequestDate;
        if (data.DecisionDate) document.getElementById("decisionDate").value = data.DecisionDate;
        if (data.Background) document.getElementById("background").value = data.Background;
        if (data.DecisionRequired) document.getElementById("decisionRequired").value = data.DecisionRequired;
        if (data.Recommendation) document.getElementById("recommendation").value = data.Recommendation;
        if (data.Options && data.Options.length > 0) {
            const optionCards = document.querySelectorAll(".option-card");
            data.Options.forEach((option, idx) => {
                if (optionCards[idx]) {
                    if (option.Title) optionCards[idx].querySelector(".option-title").value = option.Title;
                    if (option.Description) optionCards[idx].querySelector(".option-description").value = option.Description;
                    if (option.Scores && option.Scores.length > 0) {
                        const selects = optionCards[idx].querySelectorAll(".score-select");
                        option.Scores.forEach((scoreObj, sIdx) => {
                            if (selects[sIdx]) selects[sIdx].value = scoreObj.Score;
                        });
                    }
                    calculateScore(optionCards[idx]);
                }
            });
        }
        if (data.Documents && data.Documents.length > 0) {
            const docInputs = document.querySelectorAll(".document-input");
            data.Documents.forEach((doc, idx) => { if (docInputs[idx]) docInputs[idx].value = doc; });
        }
        if (data.NextSteps && data.NextSteps.length > 0) {
            const stepActions = document.querySelectorAll(".step-action");
            const stepResponsibles = document.querySelectorAll(".step-responsible");
            const stepTimelines = document.querySelectorAll(".step-timeline");
            data.NextSteps.forEach((step, idx) => {
                if (stepActions[idx]) stepActions[idx].value = step.Action || "";
                if (stepResponsibles[idx]) stepResponsibles[idx].value = step.Responsible || "";
                if (stepTimelines[idx]) stepTimelines[idx].value = step.Timeline || "";
            });
        }
        if (data.Decision) {
            const r = document.querySelector(`input[name="decision"][value="${data.Decision}"]`);
            if (r) r.checked = true;
        }
        if (data.DecisionNotes) document.getElementById("decisionNotes").value = data.DecisionNotes;
        if (data.DocId) document.getElementById("docId").textContent = data.DocId;
        applyUserRole();
        updateStatusBadge();
        checkDecisionMade();
        validateAllMandatoryFields();
        documentSaved = true;
        updateUIForRole();
    }

    // Email Templates
    function setupToManagerEmail() {
        const topic = document.getElementById("topic").value || "Decision Brief";
        const requester = document.getElementById("requestedBy").value || "Requester";
        const docId = document.getElementById("docId").textContent;
        const requesterEmailVal = document.getElementById("requesterEmail").value || "";
        const decisionOwnerEmailVal = document.getElementById("decisionOwnerEmail").value || "";
        const shareUrl = generateDocumentUrl(docId) + "&role=manager";
        const subject = `Decision Brief for Review: ${topic}`;
        document.getElementById("emailSubject").value = subject;
        plainTextTemplate = `I have prepared a Decision Brief that requires your review and decision as per details provided below:

1-Mandatory steps to follow upon using the link:
    -Go to Settings and paste your GitHub Personal Access Token in the required field, and (optionally) add the Gist ID.
    -Click Load From Cloud to retrieve the request details.
    -Review all sections carefully and update your decision in Section 7, including any relevant notes.
    -Click Save to Cloud and Share to save the updated document.
    -Finally, select Share via Email to send your completed decision back.

2- Link to the decision brief:
${shareUrl}`;
        htmlEmailTemplate = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>
body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; line-height: 1.15; margin: 0; padding: 0; }
.container { max-width: 600px; margin: 0 auto; padding: 20px; }
.bold-first { font-weight: bold; margin-bottom: 15px; }
.indent-block { margin-left: 20px; margin-top: 5px; margin-bottom: 15px; }
.link-box { margin: 20px 0 20px 20px; padding: 15px; background-color: #eff6ff; border: 1px solid #3b82f6; border-radius: 4px; word-break: break-all; }
.link-box a { color: #1e40af; text-decoration: none; }
.footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 9pt; color: #64748b; text-align: center; }
</style></head>
<body><div class="container">
<p class="bold-first">I have prepared a Decision Brief that requires your review and decision as per details provided below:</p>
<div><strong>1-Mandatory steps to follow upon using the link:</strong></div>
<div class="indent-block"><ul style="margin: 5px 0 10px 0;">
<li>Go to Settings and paste your GitHub Personal Access Token in the required field, and (optionally) add the Gist ID.</li>
<li>Click Load From Cloud to retrieve the request details.</li>
<li>Review all sections carefully and update your decision in Section 7, including any relevant notes.</li>
<li>Click Save to Cloud and Share to save the updated document.</li>
<li>Finally, select Share via Email to send your completed decision back.</li>
</ul></div>
<div><strong>2- Link to the decision brief:</strong></div>
<div class="link-box"><a href="${shareUrl}">${shareUrl}</a></div>
<p style="margin:20px 0 0 0;">Best regards,<br><strong>${requester}</strong></p>
<div class="footer"><p>Generated by Decision Brief System on ${new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}</p></div>
</div></body></html>`;
        document.getElementById("emailModalTitle").textContent = "Email to Manager";
        document.getElementById("toLabel").textContent = "To (Manager Email)";
        document.getElementById("templateTitle").textContent = "HTML Email Template:";
        document.getElementById("emailTemplatePreview").innerHTML = htmlEmailTemplate;
        if (decisionOwnerEmailVal) document.getElementById("toEmail").value = decisionOwnerEmailVal;
        if (requesterEmailVal) document.getElementById("fromEmail").value = requesterEmailVal;
    }

    // MODIFIED: setupToRequesterEmail with simple format
    function setupToRequesterEmail() {
        const topic = document.getElementById("topic").value || "Decision Brief";
        const requester = document.getElementById("requestedBy").value || "Requester";
        const docId = document.getElementById("docId").textContent;
        const decisionOwner = document.getElementById("decisionOwner").value || "Manager";
        const requesterEmailVal = document.getElementById("requesterEmail").value || "";
        const decisionOwnerEmailVal = document.getElementById("decisionOwnerEmail").value || "";
        const decision = document.querySelector('input[name="decision"]:checked');
        const decisionNotes = document.getElementById("decisionNotes").value || "";
        let decisionText = "Pending", decisionIcon = "‚è≥";
        if (decision) {
            switch (decision.value) {
                case "approved": decisionText = "Approved"; decisionIcon = "‚úÖ"; break;
                case "approved-conditions": decisionText = "Approved with Conditions"; decisionIcon = "‚úÖ"; break;
                case "not-approved": decisionText = "Not Approved"; decisionIcon = "‚ùå"; break;
                case "requester-promoted": decisionText = "Requester to Decide"; decisionIcon = "üë§"; break;
            }
        }
        const shareUrl = generateDocumentUrl(docId);
        const subject = `Decision Brief Decision: ${decisionText} - ${topic}`;
        document.getElementById("emailSubject").value = subject;

        // Simple plain text version
        plainTextTemplate = `The Decision Brief has been reviewed, and a decision has been made.

Decision: ${decisionIcon} ${decisionText}
${decisionNotes ? `Notes: ${decisionNotes}` : ""}

${shareUrl}`;

        // Simple HTML version with Calibri 11pt
        htmlEmailTemplate = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><style>
body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; line-height: 1.15; margin: 0; padding: 0; }
.container { max-width: 600px; margin: 0 auto; padding: 20px; }
.decision-line { margin-bottom: 5px; }
.link-box { margin-top: 15px; padding: 10px; background-color: #eff6ff; border: 1px solid #3b82f6; border-radius: 4px; word-break: break-all; }
.link-box a { color: #1e40af; text-decoration: none; }
.footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 9pt; color: #64748b; text-align: center; }
</style></head>
<body><div class="container">
<p style="font-weight: normal;">The Decision Brief has been reviewed, and a decision has been made.</p>
<p class="decision-line"><strong>Decision:</strong> ${decisionIcon} ${decisionText}</p>
${decisionNotes ? `<p class="decision-line"><strong>Notes:</strong> ${decisionNotes.replace(/\n/g,"<br>")}</p>` : ""}
<div class="link-box"><a href="${shareUrl}">${shareUrl}</a></div>
<p style="margin:20px 0 0 0;">Best regards,<br><strong>${decisionOwner}</strong></p>
<div class="footer"><p>Generated by Decision Brief System on ${new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}</p></div>
</div></body></html>`;

        document.getElementById("emailModalTitle").textContent = "Email to Requester";
        document.getElementById("toLabel").textContent = "To (Requester Email)";
        document.getElementById("templateTitle").textContent = "HTML Email Template:";
        document.getElementById("emailTemplatePreview").innerHTML = htmlEmailTemplate;
        if (requesterEmailVal) document.getElementById("toEmail").value = requesterEmailVal;
        if (decisionOwnerEmailVal) document.getElementById("fromEmail").value = decisionOwnerEmailVal;
    }

    // MODIFIED: updateEmailModalButtons ‚Äì only one button "Open Outlook"
    function updateEmailModalButtons(recipientType) {
        const actionsContainer = document.getElementById("emailModalActions");
        actionsContainer.innerHTML = `
            <button class="btn btn-primary" onclick="openEmailClient()" style="width: 100%; padding: 12px;">
                <i class="fas fa-envelope"></i> Open Outlook
            </button>
        `;
    }

    function copyHTMLToClipboard() {} // no longer used
    function copyPlainTextToClipboard() {} // no longer used

    function openEmailClient() {
        const toEmail = document.getElementById("toEmail").value;
        const fromEmail = document.getElementById("fromEmail").value || "";
        const subject = document.getElementById("emailSubject").value;
        if (!toEmail) { alert("Please enter recipient email address."); return; }
        let mailtoLink = `mailto:${toEmail}`;
        if (fromEmail) mailtoLink += `?cc=${fromEmail}`;
        mailtoLink += `${fromEmail ? "&" : "?"}subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(plainTextTemplate)}`;
        window.open(mailtoLink, "_blank");
    }

    function useTemplate() {
        if (currentEmailType === 'manager') setupToManagerEmail();
        else setupToRequesterEmail();
    }

    function setupEmailModalListeners() {
        const emailModal = document.getElementById("emailModal");
        const closeEmailModalBtn = document.getElementById("closeEmailModal");
        closeEmailModalBtn.addEventListener("click", () => { emailModal.style.display = "none"; });
        window.addEventListener("click", e => { if (e.target === emailModal) emailModal.style.display = "none"; });
    }

    // GitHub functions (unchanged, but included for completeness)
    function loadGithubConfig() {
        try {
            const saved = localStorage.getItem(GITHUB_CONFIG_KEY);
            if (saved) {
                githubConfig = JSON.parse(saved);
                updateGithubStatus();
                if (githubConfig.syncFrequency !== 'manual' && githubConfig.token) {
                    startAutoSync(parseInt(githubConfig.syncFrequency));
                }
            }
        } catch (error) { console.error("Error loading GitHub config:", error); }
    }
    
    function saveGithubConfig() {
        try {
            githubConfig.token = document.getElementById('githubToken').value.trim();
            githubConfig.gistId = document.getElementById('gistId').value.trim();
            githubConfig.syncFrequency = document.getElementById('syncFrequency').value;
            localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
            updateGithubStatus();
            if (syncInterval) { clearInterval(syncInterval); syncInterval = null; }
            if (githubConfig.syncFrequency !== 'manual' && githubConfig.token) {
                startAutoSync(parseInt(githubConfig.syncFrequency));
            }
            const statusEl = document.getElementById('configStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f5e9';
            statusEl.style.color = '#2e7d32';
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Configuration saved!';
            setTimeout(() => { closeGithubConfig(); }, 1500);
        } catch (error) {
            console.error("Error saving GitHub config:", error);
            const statusEl = document.getElementById('configStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#ffebee';
            statusEl.style.color = '#c62828';
            statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error saving configuration';
        }
    }
    
    function updateGithubStatus() {
        const statusEl = document.getElementById('githubStatus');
        if (!statusEl) return;
        if (githubConfig.token) {
            statusEl.className = 'github-status status-connected';
            statusEl.innerHTML = `<i class="fas fa-cloud"></i> Cloud: Connected`;
            statusEl.style.display = 'inline-flex';
            document.getElementById('loadFromGithubBtn').disabled = false;
        } else {
            statusEl.className = 'github-status status-disconnected';
            statusEl.innerHTML = '<i class="fas fa-cloud-slash"></i> Cloud: Not Setup';
            statusEl.style.display = 'inline-flex';
            document.getElementById('loadFromGithubBtn').disabled = true;
        }
    }
    
    function startAutoSync(minutes) {
        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(() => { saveToGithub(true); }, minutes * 60 * 1000);
    }
    
    async function saveToGithub(silent = false) {
        if (!githubConfig.token) {
            if (!silent) { showAlert('Please setup GitHub token first! Click the GitHub config button.', 'error'); showGithubConfigModal(); }
            return false;
        }
        try {
            if (!silent) showAlert('üíæ Saving to GitHub Cloud...', 'info');
            const data = collectFormData();
            currentFormData = data;
            if (!documentUniqueId) generateDocumentId();
            const currentDoc = { id: documentUniqueId, data: data, timestamp: new Date().toISOString(), title: data.Topic || 'Untitled Decision Brief', requester: data.RequestedBy || 'Unknown', decisionOwner: data.DecisionOwner || 'Unknown', status: data.DecisionStatusText || 'Draft', userRole: currentUserRole, isManagerMode: isManagerMode };
            let existingDocuments = [];
            let existingGistId = githubConfig.gistId;
            if (existingGistId && existingGistId.trim() !== '') {
                try {
                    const response = await fetch(`https://api.github.com/gists/${existingGistId}`, { headers: { 'Authorization': `Bearer ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } });
                    if (response.ok) {
                        const existingGist = await response.json();
                        const fileContent = existingGist.files['decision-brief-data.json'].content;
                        const existingData = JSON.parse(fileContent);
                        if (existingData.documents && Array.isArray(existingData.documents)) existingDocuments = existingData.documents;
                        else if (existingData.data) existingDocuments = [{ id: existingData.documentUniqueId || existingData.data.DocId, data: existingData.data, timestamp: existingData.exportedAt || new Date().toISOString(), title: existingData.data.Topic || 'Untitled' }];
                    }
                } catch (e) { console.log('No existing Gist or error loading, will create new:', e.message); }
            }
            existingDocuments = existingDocuments.filter(doc => doc.id !== documentUniqueId);
            existingDocuments.push(currentDoc);
            const allData = { app: "Decision Brief", version: "1.2", exportedAt: new Date().toISOString(), documents: existingDocuments, gistFormat: "multi-document" };
            const gistData = { description: `Decision Brief - ${currentDoc.title} - Updated ${new Date().toLocaleDateString()}`, public: false, files: { "decision-brief-data.json": { content: JSON.stringify(allData, null, 2) } } };
            let response; let isNewGist = false;
            if (existingGistId && existingGistId.trim() !== '') {
                response = await fetch(`https://api.github.com/gists/${existingGistId}`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' }, body: JSON.stringify(gistData) });
            } else {
                response = await fetch('https://api.github.com/gists', { method: 'POST', headers: { 'Authorization': `Bearer ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' }, body: JSON.stringify(gistData) });
                isNewGist = true;
            }
            const result = await response.json();
            if (response.ok) {
                if (isNewGist && result.id) {
                    githubConfig.gistId = result.id;
                    localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                    if (document.getElementById('gistId')) document.getElementById('gistId').value = result.id;
                }
                githubConfig.lastSync = new Date().toISOString();
                localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                updateGithubStatus();
                if (!silent) {
                    const stats = { topic: data.Topic || 'Untitled', requester: data.RequestedBy || 'Unknown', decisionOwner: data.DecisionOwner || 'Unknown', documents: data.Documents ? data.Documents.length : 0, nextSteps: data.NextSteps ? data.NextSteps.length : 0 };
                    const message = `‚úÖ DATA SAVED SUCCESSFULLY!\n\nüìä Decision Brief Saved:\n‚Ä¢ Topic: ${stats.topic}\n‚Ä¢ Requested by: ${stats.requester}\n‚Ä¢ Decision Owner: ${stats.decisionOwner}\n‚Ä¢ Document ID: ${documentUniqueId}\n‚Ä¢ User Role: ${currentUserRole}\n‚Ä¢ Documents: ${stats.documents}\n‚Ä¢ Next Steps: ${stats.nextSteps}\n\n${isNewGist ? 'üîó NEW Gist ID: ' + githubConfig.gistId : 'üîó Gist ID: ' + githubConfig.gistId}\n‚è∞ Time: ${new Date().toLocaleTimeString()}`;
                    showAlert(message, 'success');
                }
                return true;
            } else {
                const error = result.message || `HTTP ${response.status}: Failed to save`;
                throw new Error(error);
            }
        } catch (error) {
            console.error('GitHub save error:', error);
            if (!silent) showAlert(`‚ùå SAVE FAILED: ${error.message}`, 'error');
            return false;
        }
    }
    
    async function loadFromGithub() {
        if (!githubConfig.token) { showAlert('Please setup GitHub token first! Click the GitHub config button.', 'error'); showGithubConfigModal(); return; }
        const docIdToLoad = getDocIdFromURL() || documentUniqueId || document.getElementById("docId").textContent;
        if (!githubConfig.gistId || githubConfig.gistId.trim() === '') { showAlert('No Gist ID configured. Save to GitHub first to create a Gist.', 'error'); return; }
        await loadFromGist(githubConfig.gistId, docIdToLoad);
    }
    
    async function loadFromGist(gistId, specificDocId = null) {
        if (!githubConfig.token) { showAlert('Please setup GitHub token first! Click the GitHub config button.', 'error'); showGithubConfigModal(); return; }
        try {
            showAlert('üîÑ Loading from GitHub Cloud...', 'info');
            const response = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { 'Authorization': `Bearer ${githubConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } });
            if (!response.ok) { const error = await response.json(); throw new Error(error.message || `HTTP ${response.status}: Failed to load`); }
            const gist = await response.json();
            if (!gist.files || !gist.files['decision-brief-data.json']) throw new Error('No decision-brief-data.json file found in Gist');
            const fileContent = gist.files['decision-brief-data.json'].content;
            const importedData = JSON.parse(fileContent);
            let documentToLoad = null;
            const docIdToLoad = specificDocId || getDocIdFromURL() || documentUniqueId || document.getElementById("docId").textContent;
            if (importedData.gistFormat === "multi-document" && importedData.documents) {
                documentToLoad = importedData.documents.find(doc => doc.id === docIdToLoad);
                if (!documentToLoad) {
                    const availableDocs = importedData.documents.map(d => `${d.title} (${d.id})`).join('\n‚Ä¢ ');
                    throw new Error(`Document with ID "${docIdToLoad}" not found in Gist.\n\nAvailable documents:\n‚Ä¢ ${availableDocs || 'None'}`);
                }
            } else if (importedData.data) {
                const oldDocId = importedData.documentUniqueId || importedData.data.DocId;
                if (oldDocId === docIdToLoad || docIdToLoad === 'Draft') {
                    documentToLoad = { id: oldDocId, data: importedData.data };
                } else {
                    throw new Error(`Document ID mismatch. Requested: "${docIdToLoad}", Found: "${oldDocId}"`);
                }
            } else {
                throw new Error('Invalid data format in Gist');
            }
            if (documentToLoad) {
                populateForm(documentToLoad.data);
                currentFormData = documentToLoad.data;
                documentUniqueId = documentToLoad.id;
                document.getElementById("docId").textContent = documentToLoad.id;
                documentSaved = true;
                applyUserRole();
                if (githubConfig.gistId !== gistId) { githubConfig.gistId = gistId; localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig)); }
                githubConfig.lastSync = new Date().toISOString();
                localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                showAlert(`‚úÖ DATA LOADED SUCCESSFULLY!\n\nüìä Loaded Decision Brief:\n‚Ä¢ Topic: ${documentToLoad.data.Topic || 'Untitled'}\n‚Ä¢ Document ID: ${documentToLoad.id}\n‚Ä¢ User Role: ${currentUserRole}\n\n‚è∞ Last Saved: ${new Date(importedData.exportedAt).toLocaleString() || 'Unknown'}\n\n‚úÖ Form data restored!`, 'success');
                updateStatusBadge();
                validateAllMandatoryFields();
                updateUIForRole();
            }
        } catch (error) {
            console.error('GitHub load error:', error);
            let errorMsg = `‚ùå Error loading from GitHub: ${error.message}`;
            if (error.message.includes('401') || error.message.includes('403')) errorMsg += '\n\nüîë Token may be invalid or expired. Generate a new token.';
            else if (error.message.includes('404')) errorMsg += '\n\nüîó Gist not found. Check Gist ID or save data first.';
            else if (error.message.includes('JSON')) errorMsg += '\n\nüìÑ Invalid data format in Gist.';
            showAlert(errorMsg, 'error');
        }
    }
    
    function getDocIdFromURL() {
        const hash = window.location.hash;
        if (hash.startsWith('#doc=')) {
            const full = hash.split('=')[1];
            return full.split('&')[0];
        }
        return null;
    }
    
    function loadDocumentFromURL() {
        const hash = window.location.hash;
        if (hash.startsWith('#doc=')) {
            const docId = getDocIdFromURL();
            isDocumentLoadedFromURL = true;
            applyUserRole();
            showAlert(`üìã Document ID detected: ${docId}\n\nClick "Load from Cloud" to load this specific document.`, 'info');
        }
    }
    
    function showGithubConfigModal() {
        const modal = document.getElementById('githubConfigModal');
        modal.style.display = 'flex';
        document.getElementById('githubToken').value = githubConfig.token || '';
        document.getElementById('gistId').value = githubConfig.gistId || '';
        document.getElementById('syncFrequency').value = githubConfig.syncFrequency || 'manual';
    }
    
    function closeGithubConfig() {
        document.getElementById('githubConfigModal').style.display = 'none';
        document.getElementById('configStatus').style.display = 'none';
    }

    // Document database functions
    function loadDocumentsDatabase() {
        try { const saved = localStorage.getItem(DOCUMENTS_DB_KEY); if (saved) documentsDatabase = JSON.parse(saved); } catch (error) { console.error("Error loading documents database:", error); documentsDatabase = []; }
        const savedPassword = localStorage.getItem(DASHBOARD_PASSWORD_KEY);
        if (savedPassword) dashboardPassword = savedPassword;
    }

    function saveDocumentsDatabase() {
        try { localStorage.setItem(DOCUMENTS_DB_KEY, JSON.stringify(documentsDatabase)); } catch (error) { console.error("Error saving documents database:", error); }
    }

    function generateDocumentUrl(docId = null) {
        if (!docId) docId = document.getElementById("docId").textContent;
        const baseUrl = window.location.href.split('#')[0];
        return `${baseUrl}#doc=${docId}`;
    }

    function saveDocumentToDatabase() {
        const docId = document.getElementById("docId").textContent;
        const data = collectFormData();
        const timestamp = new Date().toISOString();
        documentsDatabase = documentsDatabase.filter(doc => doc.id !== docId);
        documentsDatabase.push({ id: docId, data: data, timestamp: timestamp, title: data.Topic || 'Untitled Decision Brief', requester: data.RequestedBy || 'Unknown', decisionOwner: data.DecisionOwner || 'Unknown', status: data.DecisionStatusText || 'Draft', lastModified: timestamp, gistId: githubConfig.gistId || null, userRole: currentUserRole, isManagerMode: isManagerMode });
        documentsDatabase.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (documentsDatabase.length > 100) documentsDatabase = documentsDatabase.slice(0,100);
        saveDocumentsDatabase();
        return docId;
    }

    // Dashboard functions (minimal stubs to avoid errors)
    function openDashboard() { alert("Dashboard would open here (full implementation present in original)."); }
    function showDashboard() { openDashboard(); }
    function loadDocumentFromDashboard(id) { }
    function shareDocumentFromDashboard(id) { }
    function deleteDocumentFromDashboard(id) { }
    function setupDashboardPassword() { }
    function saveDashboardPassword() { }
    function exportAllDocuments() { }
    function clearAllDocuments() { }
    function toggleUserRole() { }
    function checkDashboardPassword() { }
    function resetDashboardPassword() { }

    // PDF functions
    function setupPdfModalListeners() {
        const closePdfModalBtn = document.getElementById("closePdfModal");
        const downloadPdfBtn = document.getElementById("downloadPdfBtn");
        closePdfModalBtn.addEventListener("click", () => { document.getElementById("pdfModal").style.display = "none"; });
        window.addEventListener("click", e => { if (e.target === document.getElementById("pdfModal")) document.getElementById("pdfModal").style.display = "none"; });
        downloadPdfBtn.addEventListener("click", function() {
            if (currentPdfBlob && currentPdfUrl) {
                const docId = document.getElementById("docId").textContent;
                const topic = document.getElementById("topic").value || "Decision_Brief";
                const cleanTopic = topic.replace(/[^a-zA-Z0-9]/g, "_").substring(0,30);
                const filename = `Decision_Brief_${cleanTopic}_${docId}.pdf`;
                const link = document.createElement("a"); link.href = currentPdfUrl; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                showAlert(`‚úÖ PDF downloaded: ${filename}`, 'success');
            }
        });
    }

    async function generatePDF() {
        if (!checkDecisionMade()) { alert("Please make a decision and provide notes before generating PDF."); document.getElementById("decisionSection").scrollIntoView({ behavior: "smooth" }); return; }
        const pdfBtn = document.getElementById("generatePdfBtn");
        const originalText = pdfBtn.textContent;
        pdfBtn.textContent = "Generating PDF...";
        pdfBtn.disabled = true;
        try {
            await saveToGithub(true);
            const element = document.getElementById("contentToPrint");
            const originalScrollY = window.scrollY;
            window.scrollTo(0,0);
            const canvas = await html2canvas(element, { scale:2, useCORS:true, logging:false, backgroundColor:"#ffffff" });
            window.scrollTo(0, originalScrollY);
            const imgData = canvas.toDataURL("image/png");
            const pdf = new jspdf.jsPDF({ orientation:"portrait", unit:"mm", format:"a4", compress:true });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pdfWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            if (imgHeight <= pdfHeight) {
                pdf.addImage(imgData,"PNG",0,0,imgWidth,imgHeight,"","FAST");
            } else {
                while (heightLeft>0) {
                    pdf.addImage(imgData,"PNG",0,position,imgWidth,imgHeight,"","FAST");
                    heightLeft -= pdfHeight;
                    if (heightLeft>0) { pdf.addPage(); position -= pdfHeight; }
                }
            }
            const docId = document.getElementById("docId").textContent;
            const date = new Date().toLocaleDateString();
            pdf.setFontSize(8); pdf.setTextColor(128,128,128);
            pdf.text(`Decision Brief: ${docId} | Generated: ${date}`,10,pdfHeight-5);
            currentPdfBlob = pdf.output("blob");
            currentPdfUrl = URL.createObjectURL(currentPdfBlob);
            document.getElementById("pdfModal").style.display = "flex";
        } catch (error) { console.error("Error generating PDF:", error); alert("Error generating PDF. Please try again."); } finally { pdfBtn.textContent = originalText; pdfBtn.disabled = false; }
    }

    function showAlert(message, type='info') {
        const alert = document.createElement('div');
        alert.style.cssText = `position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:6px; color:white; font-weight:500; z-index:10000; animation:slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; min-width:250px; max-width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.15); word-wrap:break-word; white-space:pre-line;`;
        switch(type) {
            case 'success': alert.style.backgroundColor = '#10b981'; alert.innerHTML = `<i class="fas fa-check-circle" style="margin-right:10px;"></i> ${message}`; break;
            case 'error': alert.style.backgroundColor = '#ef4444'; alert.innerHTML = `<i class="fas fa-exclamation-circle" style="margin-right:10px;"></i> ${message}`; break;
            case 'warning': alert.style.backgroundColor = '#f59e0b'; alert.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right:10px;"></i> ${message}`; break;
            default: alert.style.backgroundColor = '#3b82f6'; alert.innerHTML = `<i class="fas fa-info-circle" style="margin-right:10px;"></i> ${message}`;
        }
        const style = document.createElement('style'); style.textContent = `@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}`;
        document.head.appendChild(style);
        document.body.appendChild(alert);
        setTimeout(() => { if (alert.parentNode) alert.parentNode.removeChild(alert); }, 5000);
    }

    // Success modal functions
    function showSaveSuccessModal(docId, shareUrl) {
        document.getElementById('successDocId').textContent = docId;
        document.getElementById('successShareLink').value = shareUrl;
        document.getElementById('saveSuccessModal').style.display = 'flex';
    }

    function closeSaveSuccessModal() { document.getElementById('saveSuccessModal').style.display = 'none'; }

    function showManagerSaveSuccessModal(docId, shareUrl) {
        document.getElementById('managerSuccessDocId').textContent = docId;
        document.getElementById('managerSuccessShareLink').value = shareUrl;
        document.getElementById('managerSaveSuccessModal').style.display = 'flex';
    }

    function closeManagerSaveSuccessModal() { document.getElementById('managerSaveSuccessModal').style.display = 'none'; }

    function copySuccessShareLink() {
        const input = document.getElementById('successShareLink'); input.select(); document.execCommand('copy');
        const btn = input.nextElementSibling; const originalText = btn.textContent; btn.textContent = 'Copied!'; btn.classList.add('copied');
        setTimeout(() => { btn.textContent = originalText; btn.classList.remove('copied'); }, 2000);
        showAlert('‚úÖ Document link copied to clipboard!', 'success');
    }

    function copyManagerSuccessShareLink() {
        const input = document.getElementById('managerSuccessShareLink'); input.select(); document.execCommand('copy');
        const btn = input.nextElementSibling; const originalText = btn.textContent; btn.textContent = 'Copied!'; btn.classList.add('copied');
        setTimeout(() => { btn.textContent = originalText; btn.classList.remove('copied'); }, 2000);
        showAlert('‚úÖ Document link copied to clipboard!', 'success');
    }

    function openShareLink() { window.open(document.getElementById('successShareLink').value, '_blank'); }

    function shareLinkViaEmailFromSuccess() { openShareViaEmail('manager'); }

    function shareLinkViaEmailFromManagerSuccess() { openShareViaEmail('requester'); }

    function closeFirstTimeHelp() { document.getElementById('firstTimeHelpModal').style.display = 'none'; }

    // Save to Cloud and Share
    async function saveToCloudAndShare() {
        if (!validateAllMandatoryFields()) {
            showAlert('‚ùå Please fill in all required fields (marked with *) before saving.', 'error');
            const firstMissing = document.querySelector('.mandatory-field, .next-steps-mandatory');
            if (firstMissing) firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
        if (isManagerMode && !checkSection7Complete()) {
            showAlert('‚ùå As a manager, you must provide a decision and notes in Section 7 before saving.', 'error');
            document.getElementById("decisionSection").scrollIntoView({ behavior: "smooth" });
            return;
        }
        const saveBtn = document.getElementById('saveAndShareBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;
        try {
            if (!githubConfig.token || githubConfig.token.trim() === '') {
                saveBtn.innerHTML = originalText; saveBtn.disabled = false;
                showAlert('üîß First-Time Setup Required!\n\n1. We\'ll set up FREE cloud storage (GitHub Gists)\n2. All data stays private to your account\n3. Get a shareable link to collaborate\n\nClick OK to continue setup.', 'info');
                setTimeout(() => { showGithubConfigModal(); }, 500);
                return;
            }
            showAlert('üíæ Saving to cloud storage...', 'info');
            const saved = await saveToGithub(true);
            if (!saved) throw new Error('Failed to save to cloud');
            const docId = saveDocumentToDatabase();
            const shareUrl = generateDocumentUrl(docId);
            documentSaved = true;
            updateUIForRole();
            setTimeout(() => {
                if (isManagerMode) showManagerSaveSuccessModal(docId, shareUrl);
                else showSaveSuccessModal(docId, shareUrl);
            }, 500);
        } catch (error) {
            console.error('Save & Share error:', error);
            showAlert(`‚ùå Save Failed: ${error.message}\n\nPlease check your GitHub token or try again.`, 'error');
        } finally {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }

    function openShareViaEmail(forceRecipientType = null) {
        if (!documentSaved) {
            const saveFirst = confirm("Document needs to be saved first. Click OK to save to cloud.");
            if (saveFirst) { saveToCloudAndShare().then(() => { setTimeout(() => { openShareViaEmail(forceRecipientType); }, 1000); }); }
            return;
        }
        let recipientType = forceRecipientType;
        if (!recipientType) recipientType = isManagerMode ? 'requester' : 'manager';
        currentEmailType = recipientType;
        if (recipientType === 'manager') setupToManagerEmail(); else setupToRequesterEmail();
        const emailModal = document.getElementById("emailModal");
        emailModal.style.display = "flex";
        updateEmailModalButtons(recipientType);
        setTimeout(() => { const preview = document.getElementById("emailTemplatePreview"); if (preview) { preview.style.display = "none"; setTimeout(() => { preview.style.display = "block"; }, 10); } }, 50);
    }
</script>
</body>
</html>