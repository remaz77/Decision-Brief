<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Brief</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add Font Awesome for GitHub icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS remains the same as before, just including the essential parts */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.5; padding: 20px; }
        .toolbar { display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px; padding: 16px 0; margin-bottom: 20px; }
        .toolbar-left, .toolbar-right { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: 1px solid #cbd5e1; background: white; border-radius: 8px; font-family: inherit; font-size: 14px; font-weight: 600; color: #475569; cursor: pointer; transition: all 0.2s ease; }
        .btn:hover { background: #f1f5f9; border-color: #94a3b8; }
        .btn-primary { background: #1e293b; color: white; border-color: #1e293b; }
        .btn-primary:hover { background: #0f172a; border-color: #0f172a; }
        .btn-success { background: #10b981; color: white; border-color: #10b981; }
        .btn-success:hover { background: #059669; border-color: #059669; }
        .btn-info { background: #3b82f6; color: white; border-color: #3b82f6; }
        .btn-info:hover { background: #2563eb; border-color: #2563eb; }
        .btn-warning { background: #f59e0b; color: white; border-color: #f59e0b; }
        .btn-warning:hover { background: #d97706; border-color: #d97706; }
        .btn-email { background: #8b5cf6; color: white; border-color: #8b5cf6; }
        .btn-email:hover { background: #7c3aed; border-color: #7c3aed; }
        .btn-danger { background: #ef4444; color: white; border-color: #ef4444; }
        .btn-danger:hover { background: #dc2626; border-color: #dc2626; }
        
        /* GitHub button styles */
        .btn-github { 
            background: #333; 
            color: white; 
            border-color: #333; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-github:hover { background: #444; border-color: #444; }
        .btn-github.save { background: #238636; border-color: #238636; }
        .btn-github.save:hover { background: #2ea043; border-color: #2ea043; }
        .btn-github.load { background: #1e293b; border-color: #1e293b; }
        .btn-github.load:hover { background: #0f172a; border-color: #0f172a; }
        .btn-github.config { background: #6e40c9; border-color: #6e40c9; }
        .btn-github.config:hover { background: #7c3aed; border-color: #7c3aed; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 20px; font-weight: 700; color: #1e293b; }
        .close-btn { background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .close-btn:hover { background: #f1f5f9; color: #1e293b; }
        .modal-body { margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #475569; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 14px; background: white; transition: all 0.2s ease; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .share-link-container, .pdf-link-container { display: flex; gap: 8px; margin-top: 12px; }
        .share-link-input, .pdf-link-input { flex: 1; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 14px; background: #f8fafc; color: #475569; font-size: 12px; }
        .copy-btn { padding: 10px 16px; background: #1e293b; color: white; border: none; border-radius: 6px; font-family: inherit; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .copy-btn:hover { background: #0f172a; }
        .copy-btn.copied { background: #10b981; }
        .instructions { margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6; font-size: 13px; color: #475569; }
        .instructions p { margin-bottom: 8px; }
        .instructions ul { padding-left: 20px; margin-bottom: 8px; }
        .email-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .email-template { margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .template-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .template-title { font-size: 14px; font-weight: 600; color: #475569; }
        .template-body { font-size: 12px; color: #64748b; line-height: 1.5; white-space: pre-wrap; }
        .email-options { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .email-option-btn { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; text-align: center; transition: all 0.2s ease; }
        .email-option-btn:hover { background: #f1f5f9; }
        .email-option-btn.active { border-color: #3b82f6; background: #eff6ff; }
        .email-option-btn .title { font-weight: 600; color: #1e293b; margin-bottom: 4px; }
        .email-option-btn .desc { font-size: 12px; color: #64748b; }
        .decision-mandatory .section-title::after { content: " *"; color: #ef4444; font-size: 18px; }
        .decision-mandatory textarea { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .decision-mandatory textarea:focus { border-color: #dc2626 !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.1) !important; }
        .decision-required-warning { display: none; color: #ef4444; font-size: 12px; margin-top: 4px; font-weight: 500; }
        .decision-mandatory .decision-required-warning { display: block; }
        .mandatory-field .section-title::after { content: " *"; color: #ef4444; font-size: 18px; }
        .mandatory-field input, .mandatory-field textarea, .mandatory-field select { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .mandatory-field input:focus, .mandatory-field textarea:focus, .mandatory-field select:focus { border-color: #dc2626 !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.1) !important; }
        .mandatory-warning { display: none; color: #ef4444; font-size: 12px; margin-top: 4px; font-weight: 500; }
        .mandatory-field .mandatory-warning { display: block; }

        .next-steps-mandatory .section-title::after { content: " *"; color: #ef4444; font-size: 18px; }
        .next-steps-mandatory .steps-table input { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .next-steps-mandatory .steps-table input:focus { border-color: #dc2626 !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.1) !important; }
        .next-steps-warning { display: none; color: #ef4444; font-size: 12px; margin-top: 10px; font-weight: 500; }
        .next-steps-mandatory .next-steps-warning { display: block; }

        .page { max-width: 1100px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 30px; }
        .page-title { text-align: center; font-size: 32px; font-weight: 800; color: #1e293b; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #1e293b; letter-spacing: -0.5px; }
        .metadata { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .meta-item { display: flex; flex-direction: column; gap: 6px; }
        .meta-label { font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .meta-input { padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 36px; }
        .meta-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .section { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
        .section-title { font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #1e293b; display: flex; align-items: center; gap: 8px; }
        .section-number { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: #1e293b; color: white; border-radius: 6px; font-weight: 700; font-size: 12px; }
        .section-1-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-height: 150px; }
        .section-1-2 > div { display: flex; flex-direction: column; }
        .text-section { flex: 1; display: flex; flex-direction: column; }
        .text-section textarea { flex: 1; min-height: 120px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; line-height: 1.5; resize: vertical; background: white; transition: all 0.2s ease; }
        .text-section textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .options-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .option-card { border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; background: white; display: flex; flex-direction: column; min-height: 240px; }
        .option-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .option-name { font-size: 14px; font-weight: 700; color: #1e293b; }
        .score-display { background: #1e293b; color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 700; min-width: 70px; text-align: center; flex-shrink: 0; }
        .option-input { margin-bottom: 8px; flex-shrink: 0; }
        .option-input input { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 34px; }
        .option-input input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .criteria-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; flex: 1; min-height: 120px; }
        .criteria-table tr:not(:last-child) { border-bottom: 1px solid #e2e8f0; }
        .criteria-table td { padding: 6px 8px; vertical-align: middle; height: 30px; }
        .criteria-label { font-weight: 600; color: #475569; width: 55%; }
        .criteria-score select { width: 100%; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 12px; background: white; cursor: pointer; transition: all 0.2s ease; height: 30px; }
        .criteria-score select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 1px rgba(59,130,246,0.1); }
        .section-4-5 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-height: 150px; }
        .section-4-5 > div { display: flex; flex-direction: column; }
        .supporting-docs { flex: 1; display: flex; flex-direction: column; }
        .documents-list { display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .document-item { display: grid; grid-template-columns: 24px 1fr; gap: 10px; align-items: center; height: 36px; }
        .document-number { width: 22px; height: 22px; background: #64748b; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; flex-shrink: 0; }
        .recommendation-box { flex: 1; display: flex; flex-direction: column; }
        .recommendation-box textarea { flex: 1; min-height: 120px; }
        .steps-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 8px; }
        .steps-table thead { background: #f1f5f9; }
        .steps-table th { padding: 10px 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0; font-size: 12px; }
        .steps-table td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; height: 40px; }
        .steps-table input { width: 100%; padding: 8px 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 34px; }
        .steps-table input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .decision-section { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
        .decision-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .decision-title { font-size: 16px; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px; }
        .decision-date-container { display: flex; align-items: center; gap: 8px; }
        .decision-date-label { font-size: 13px; font-weight: 600; color: #475569; }
        .decision-date-input { padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; background: white; transition: all 0.2s ease; height: 36px; min-width: 150px; }
        .decision-date-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .decision-options { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .decision-option { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .decision-option input[type="radio"] { width: 16px; height: 16px; cursor: pointer; }
        .decision-option label { font-size: 13px; font-weight: 500; color: #475569; cursor: pointer; }
        .decision-option input[type="radio"]:checked + label { color: #1e293b; font-weight: 600; }
        .decision-notes { min-height: 100px; }
        .decision-notes textarea { height: 100%; min-height: 80px; width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; line-height: 1.5; resize: vertical; background: white; transition: all 0.2s ease; }
        .decision-notes textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        .footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b; text-align: center; }
        .status-indicator { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 600; margin-left: 10px; background: #e2e8f0; color: #475569; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-conditional { background: #dbeafe; color: #1e40af; }
        .status-promoted { background: #ddd6fe; color: #5b21b6; }

        /* Dashboard Table Styles */
        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .dashboard-table thead {
            background: #f1f5f9;
        }

        .dashboard-table th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            font-size: 12px;
        }

        .dashboard-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .dashboard-table tr:hover {
            background: #f8fafc;
        }

        /* Password Modal Styles */
        .password-input-group {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
        }

        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* GitHub Status Styles */
        .github-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            background: #e2e8f0;
            color: #475569;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .token-input {
            font-family: monospace;
            font-size: 13px;
        }

        /* New merged button style */
        .btn-cloud-save {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-cloud-save:hover {
            background: linear-gradient(135deg, #059669 0%, #2563eb 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-cloud-save:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Outlook specific button */
        .btn-outlook {
            background: #0072C6;
            color: white;
            border-color: #0072C6;
        }
        
        .btn-outlook:hover {
            background: #005A9E;
            border-color: #005A9E;
        }
        
        /* Step indicators */
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .step-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .step-content {
            flex: 1;
        }
        
        /* Disabled section styles */
        .section-disabled {
            opacity: 0.6;
            pointer-events: none;
            background: #f1f5f9;
        }
        
        .section-disabled textarea,
        .section-disabled input,
        .section-disabled select {
            background: #e2e8f0;
            cursor: not-allowed;
        }
        
        /* Manager-only controls */
        .manager-only {
            display: none;
        }
        
        .manager-mode .manager-only {
            display: block;
        }
        
        .manager-mode .requester-only {
            display: none;
        }

        @media (max-width: 1024px) {
            .metadata { grid-template-columns: repeat(2, 1fr); }
            .options-grid { grid-template-columns: repeat(2, 1fr); }
            .section-1-2, .section-4-5 { grid-template-columns: 1fr; gap: 15px; }
            .decision-header { flex-direction: column; align-items: flex-start; }
        }
        @media (max-width: 768px) {
            .page { padding: 20px; }
            .toolbar { flex-direction: column; }
            .toolbar-left, .toolbar-right { width: 100%; justify-content: space-between; }
            .options-grid { grid-template-columns: 1fr; }
            .decision-options { flex-direction: column; gap: 12px; }
            .metadata { grid-template-columns: 1fr; }
            .email-actions { flex-direction: column; }
            .email-options { flex-direction: column; }
            .dashboard-table { display: block; overflow-x: auto; }
        }
        @media print {
            body { background: white; padding: 0; }
            .toolbar { display: none; }
            .modal { display: none !important; }
            .page { box-shadow: none; border-radius: 0; padding: 20px; max-width: 100%; }
            .option-card { break-inside: avoid; page-break-inside: avoid; }
            .meta-input, .option-input input, .steps-table input, textarea, select { border: 1px solid #ccc !important; background: white !important; }
            .decision-mandatory textarea, .mandatory-field input, .mandatory-field textarea { border: 1px solid #ccc !important; background: white !important; }
        }
    </style>
</head>
<body>

<!-- GitHub Configuration Modal -->
<div id="githubConfigModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><i class="fab fa-github"></i> Free Cloud Sync Setup</div>
            <button class="close-btn" onclick="closeGithubConfig()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <h4><i class="fas fa-cloud"></i> Sync with GitHub (100% Free)</h4>
                <p style="margin-bottom: 15px; color: #666;">
                    Store your Decision Brief data on GitHub Gists. All devices can sync automatically.
                </p>
            </div>
            
            <div class="form-group">
                <label class="form-label">GitHub Personal Access Token *</label>
                <input type="password" id="githubToken" class="form-input token-input" 
                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666;">
                    Get token from: <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a><br>
                    Select only: <code>gist</code> scope
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Gist ID (Optional)</label>
                <input type="text" id="gistId" class="form-input token-input" 
                       placeholder="Leave empty to create new">
                <small style="color: #666;">
                    If sharing with team, use same Gist ID on all devices
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Auto Save</label>
                <select id="syncFrequency" class="form-input">
                    <option value="manual">Manual Only</option>
                    <option value="5">Every 5 minutes</option>
                    <option value="15">Every 15 minutes</option>
                    <option value="60">Every hour</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="saveGithubConfig()" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-save"></i> Save Configuration
            </button>
            
            <div id="configStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
            
            <div class="instructions">
                <h4><i class="fas fa-question-circle"></i> Simple 3-Step Setup:</h4>
                <ol style="margin-left: 20px; color: #555;">
                    <li>Go to <a href="https://github.com/settings/tokens" target="_blank">GitHub Tokens</a></li>
                    <li>Click "Generate new token" → "Generate new token (classic)"</li>
                    <li>Name: "Decision Brief Sync"</li>
                    <li>Expiration: 90 days (recommended)</li>
                    <li>Select ONLY: <strong>gist</strong> scope ✓</li>
                    <li>Click "Generate token"</li>
                    <li>Copy token (starts with ghp_)</li>
                    <li>Paste above and save</li>
                </ol>
                <p style="margin-top: 10px; font-size: 12px; color: #777;">
                    <i class="fas fa-shield-alt"></i> Token stored locally only. 100% free forever.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Save Success Modal -->
<div id="saveSuccessModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <div class="modal-title" style="color: #10b981;">
                <i class="fas fa-check-circle"></i> Successfully Saved to Cloud!
            </div>
            <button class="close-btn" onclick="closeSaveSuccessModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <!-- Success Summary -->
            <div class="instructions" style="background: #d1fae5; border-left-color: #10b981; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-cloud" style="font-size: 24px; color: #059669;"></i>
                    <div>
                        <h4 style="margin: 0; color: #065f46;">✅ Document Saved to Cloud</h4>
                        <p style="margin: 5px 0 0 0; color: #047857; font-size: 13px;">
                            Document ID: <code id="successDocId">Loading...</code>
                        </p>
                    </div>
                </div>
                <p style="margin: 10px 0 0 0; color: #065f46;">
                    Your document is now safely stored in your GitHub account.
                </p>
            </div>

            <!-- Step-by-Step Instructions -->
            <div style="margin: 25px 0;">
                <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-list-ol"></i> Next Steps
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
                    <!-- Step 1 -->
                    <div style="background: #f0f9ff; border: 1px solid #e0f2fe; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 24px; height: 24px; background: #0ea5e9; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                            <h5 style="margin: 0; color: #0369a1;">Share with Manager</h5>
                        </div>
                        <p style="font-size: 13px; color: #475569; margin-bottom: 10px;">
                            Send to your manager for review and decision. The manager will update Section 7 and save.
                        </p>
                        <button class="btn btn-warning" onclick="openShareViaEmail('manager')" style="width: 100%; padding: 8px;">
                            <i class="fas fa-envelope"></i> Share via Email
                        </button>
                    </div>
                </div>
            </div>

            <!-- Share Link Section -->
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" style="font-size: 14px; color: #1e293b;">
                    <i class="fas fa-link"></i> Shareable Link (Copy & Share)
                </label>
                <div class="share-link-container">
                    <input type="text" class="share-link-input" id="successShareLink" value="" readonly style="font-size: 12px;">
                    <button class="copy-btn" onclick="copySuccessShareLink()">Copy Link</button>
                </div>
                <small style="color: #666; display: block; margin-top: 8px;">
                    Anyone with this link can view and edit this document (based on your GitHub permissions).
                </small>
            </div>

            <!-- Quick Actions -->
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <h5 style="color: #475569; margin-bottom: 15px; font-size: 14px;">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
                <div class="email-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="openShareLink()">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </button>
                    <button class="btn btn-primary" onclick="shareLinkViaEmailFromSuccess()">
                        <i class="fas fa-envelope"></i> Share via Email
                    </button>
                    <button class="btn btn-github" onclick="openDashboard(); closeSaveSuccessModal()">
                        <i class="fas fa-tachometer-alt"></i> View All Documents
                    </button>
                </div>
            </div>

            <!-- Help Section -->
            <div class="instructions" style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <h5 style="color: #475569; margin-bottom: 10px; font-size: 14px;">
                    <i class="fas fa-question-circle"></i> How This Works:
                </h5>
                <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                    <li><strong>Step 1:</strong> Email manager using button above or share the link</li>
                    <li><strong>Step 2:</strong> Manager opens link, updates Section 7 (mandatory), and saves</li>
                    <li><strong>Step 3:</strong> Manager emails decision back to requester</li>
                    <li><strong>Note:</strong> Section 7 is locked for requesters, only managers can update it</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Manager Save Success Modal -->
<div id="managerSaveSuccessModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <div class="modal-title" style="color: #10b981;">
                <i class="fas fa-check-circle"></i> Decision Saved to Cloud!
            </div>
            <button class="close-btn" onclick="closeManagerSaveSuccessModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <!-- Success Summary -->
            <div class="instructions" style="background: #d1fae5; border-left-color: #10b981; padding: 15px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <i class="fas fa-cloud" style="font-size: 24px; color: #059669;"></i>
                    <div>
                        <h4 style="margin: 0; color: #065f46;">✅ Decision Saved to Cloud</h4>
                        <p style="margin: 5px 0 0 0; color: #047857; font-size: 13px;">
                            Document ID: <code id="managerSuccessDocId">Loading...</code>
                        </p>
                    </div>
                </div>
                <p style="margin: 10px 0 0 0; color: #065f46;">
                    Your decision has been saved. Now share it with the requester.
                </p>
            </div>

            <!-- Step-by-Step Instructions -->
            <div style="margin: 25px 0;">
                <h4 style="color: #1e293b; margin-bottom: 15px; font-size: 16px;">
                    <i class="fas fa-list-ol"></i> Next Steps
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
                    <!-- Step 1 -->
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 24px; height: 24px; background: #f59e0b; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                            <h5 style="margin: 0; color: #92400e;">Share Decision with Requester</h5>
                        </div>
                        <p style="font-size: 13px; color: #475569; margin-bottom: 10px;">
                            Email the decision back to the requester with your decision notes.
                        </p>
                        <button class="btn btn-warning" onclick="openShareViaEmail('requester')" style="width: 100%; padding: 8px;">
                            <i class="fas fa-envelope"></i> Share via Email
                        </button>
                    </div>
                </div>
            </div>

            <!-- Share Link Section -->
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" style="font-size: 14px; color: #1e293b;">
                    <i class="fas fa-link"></i> Updated Document Link
                </label>
                <div class="share-link-container">
                    <input type="text" class="share-link-input" id="managerSuccessShareLink" value="" readonly style="font-size: 12px;">
                    <button class="copy-btn" onclick="copyManagerSuccessShareLink()">Copy Link</button>
                </div>
                <small style="color: #666; display: block; margin-top: 8px;">
                    This link now includes your decision. Share it with the requester.
                </small>
            </div>

            <!-- Quick Actions -->
            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <h5 style="color: #475569; margin-bottom: 15px; font-size: 14px;">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
                <div class="email-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generatePDF()" id="generatePdfFromManagerBtn">
                        <i class="fas fa-file-pdf"></i> Generate PDF
                    </button>
                    <button class="btn btn-success" onclick="shareLinkViaEmailFromManagerSuccess()">
                        <i class="fas fa-envelope"></i> Share via Email
                    </button>
                    <button class="btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Document
                    </button>
                </div>
            </div>

            <!-- Help Section -->
            <div class="instructions" style="margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <h5 style="color: #475569; margin-bottom: 10px; font-size: 14px;">
                    <i class="fas fa-question-circle"></i> What Happens Next:
                </h5>
                <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                    <li><strong>Share via Email:</strong> Sends your decision with notes to the requester</li>
                    <li><strong>Generate PDF:</strong> Creates a printable version of the complete document</li>
                    <li><strong>Share Link:</strong> Provides a link to the updated document with your decision</li>
                    <li><strong>The requester</strong> will receive the decision and can view it in the document</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="emailModalTitle">Create Email for Decision Brief</div>
            <button class="close-btn" id="closeEmailModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label" id="toLabel">To (Recipient Email)</label>
                <input type="email" class="form-input" id="toEmail" placeholder="email@company.com">
            </div>

            <div class="form-group">
                <label class="form-label">Your Email (Optional)</label>
                <input type="email" class="form-input" id="fromEmail" placeholder="your.email@company.com">
            </div>

            <div class="form-group">
                <label class="form-label">Subject</label>
                <input type="text" class="form-input" id="emailSubject" placeholder="Decision Brief">
            </div>

            <div class="form-group">
                <label class="form-label">Additional Message (Optional)</label>
                <textarea class="form-input form-textarea" id="additionalMessage" rows="3" placeholder="Add any additional comments or instructions..."></textarea>
            </div>

            <div class="email-template">
                <div class="template-header">
                    <div class="template-title" id="templateTitle">HTML Email Template:</div>
                    <button class="btn btn-sm" onclick="useTemplate()">Refresh Template</button>
                </div>
                <div class="template-body" id="emailTemplatePreview" style="max-height: 300px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></div>
            </div>

            <div class="email-actions" id="emailModalActions">
                <!-- Buttons will be inserted here based on email type -->
            </div>

            <div class="instructions">
                <p><strong>How to send:</strong></p>
                <ul id="emailInstructions">
                    <!-- Instructions will be inserted here -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- PDF Download Modal -->
<div id="pdfModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">PDF Ready for Download</div>
            <button class="close-btn" id="closePdfModal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Your Decision Brief PDF has been generated successfully.</p>
            
            <div class="email-actions" style="margin: 20px 0;">
                <button class="btn btn-success" id="downloadPdfBtn" style="width: 100%; padding: 15px; font-size: 16px;">
                    <i class="fas fa-download"></i> Download PDF File
                </button>
            </div>
            
            <div class="instructions">
                <p><strong>How to share:</strong></p>
                <ul>
                    <li><strong>Download PDF</strong> - Save the PDF to your computer</li>
                    <li><strong>Attach to Email</strong> - Manually attach to any email</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
    <div class="toolbar-left">
        <button class="btn" onclick="resetForm()">Reset Form</button>
        <!-- Dashboard button -->
        <button class="btn btn-info" onclick="openDashboard()" title="Manage all documents">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </button>
        <!-- GitHub buttons -->
        <button class="btn btn-github config" onclick="showGithubConfigModal()" title="GitHub Cloud Settings">
            <i class="fab fa-github"></i> <i class="fas fa-cog"></i>
        </button>
    </div>
    <div class="toolbar-right">
        <!-- Single merged Save & Share button -->
        <button class="btn btn-cloud-save" onclick="saveToCloudAndShare()" id="saveAndShareBtn" title="Save to cloud and get shareable link">
            <i class="fas fa-cloud-upload-alt"></i> Save to Cloud and Share
        </button>
        
        <!-- Load from Cloud button -->
        <button class="btn btn-github load" onclick="loadFromGithub()" id="loadFromGithubBtn" title="Load from GitHub Cloud">
            <i class="fab fa-github"></i> Load from Cloud
        </button>
        
        <!-- Single Share via Email button that changes based on role -->
        <button class="btn btn-email" id="shareViaEmailBtn" onclick="openShareViaEmail()" title="Share document via email">
            <i class="fas fa-envelope"></i> Share via Email
        </button>
        
        <button class="btn btn-primary" onclick="generatePDF()" id="generatePdfBtn" title="Please make a decision and add notes first">Generate PDF</button>
        <button class="btn" onclick="window.print()">Print</button>
    </div>
</div>

<!-- Main Page -->
<div class="page" id="contentToPrint">
    <h1 class="page-title">
        Decision Brief 
        <span id="statusBadge" class="status-indicator">Draft</span>
        <span id="githubStatus" class="github-status status-disconnected" style="display: none;">
            <i class="fas fa-cloud"></i> Cloud: Not Setup
        </span>
    </h1>

    <!-- Metadata Section -->
    <div class="metadata">
        <div class="meta-item mandatory-field" id="topicField">
            <div class="meta-label">Topic</div>
            <input type="text" class="meta-input" id="topic" placeholder="Enter decision topic">
            <div class="mandatory-warning">* This field is required</div>
        </div>
        <div class="meta-item mandatory-field" id="requesterField">
            <div class="meta-label">Requested by</div>
            <input type="text" class="meta-input" id="requestedBy" placeholder="Name of requester">
            <div class="mandatory-warning">* This field is required</div>
        </div>
        <div class="meta-item mandatory-field" id="ownerField">
            <div class="meta-label">Decision Owner</div>
            <input type="text" class="meta-input" id="decisionOwner" placeholder="Name of decision maker">
            <div class="mandatory-warning">* This field is required</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Request Date</div>
            <input type="date" class="meta-input" id="requestDate">
        </div>

        <div class="meta-item" id="requesterEmailField">
            <div class="meta-label">Requester Email</div>
            <input type="email" class="meta-input" id="requesterEmail" placeholder="requester@company.com">
        </div>

        <div class="meta-item" id="decisionOwnerEmailField">
            <div class="meta-label">Decision Owner Email</div>
            <input type="email" class="meta-input" id="decisionOwnerEmail" placeholder="manager@company.com">
        </div>
    </div>

    <!-- SECTION 1 & 2 -->
    <div class="section section-1-2">
        <div class="mandatory-field" id="backgroundField">
            <div class="section-title">
                <span class="section-number">1</span>
                Background &amp; Requirement
            </div>
            <div class="text-section">
                <textarea id="background" placeholder="Describe the context, problem statement, and business need..."></textarea>
                <div class="mandatory-warning">* This field is required</div>
            </div>
        </div>

        <div class="mandatory-field" id="decisionRequiredField">
            <div class="section-title">
                <span class="section-number">2</span>
                Decision Required
            </div>
            <div class="text-section">
                <textarea id="decisionRequired" placeholder="Clearly state the specific decision that needs to be made..."></textarea>
                <div class="mandatory-warning">* This field is required</div>
            </div>
        </div>
    </div>

    <!-- SECTION 3 -->
    <div class="section">
        <div class="section-title">
            <span class="section-number">3</span>
            Options Considered
        </div>
        <div class="options-grid" id="optionsGrid">
            <!-- Options inserted by JS -->
        </div>
    </div>

    <!-- SECTION 4 & 5 -->
    <div class="section section-4-5">
        <div>
            <div class="section-title">
                <span class="section-number">4</span>
                Supporting Documents
            </div>
            <div class="supporting-docs">
                <div class="documents-list" id="documentsList">
                    <div class="document-item">
                        <div class="document-number">1</div>
                        <input type="text" class="meta-input document-input" placeholder="Document name or link">
                    </div>
                    <div class="document-item">
                        <div class="document-number">2</div>
                        <input type="text" class="meta-input document-input" placeholder="Document name or link">
                    </div>
                    <div class="document-item">
                        <div class="document-number">3</div>
                        <input type="text" class="meta-input document-input" placeholder="Document name or link">
                    </div>
                </div>
            </div>
        </div>

        <div class="mandatory-field" id="recommendationField">
            <div class="section-title">
                <span class="section-number">5</span>
                Recommendation
            </div>
            <div class="text-section recommendation-box">
                <textarea id="recommendation" placeholder="Provide a clear recommendation with supporting rationale..."></textarea>
                <div class="mandatory-warning">* This field is required</div>
            </div>
        </div>
    </div>

    <!-- SECTION 6: Next Steps -->
    <div class="section" id="nextStepsSection">
        <div class="section-title">
            <span class="section-number">6</span>
            Next Steps (if approved)
        </div>
        <table class="steps-table">
            <thead>
                <tr>
                    <th style="width: 40%">Action</th>
                    <th style="width: 30%">Responsible</th>
                    <th style="width: 30%">Timeline</th>
                </tr>
            </thead>
            <tbody id="stepsTableBody">
                <tr>
                    <td><input type="text" class="step-action" placeholder="Describe specific action"></td>
                    <td><input type="text" class="step-responsible" placeholder="Name or role"></td>
                    <td><input type="text" class="step-timeline" placeholder="Date or timeframe"></td>
                </tr>
                <tr>
                    <td><input type="text" class="step-action" placeholder="Describe specific action"></td>
                    <td><input type="text" class="step-responsible" placeholder="Name or role"></td>
                    <td><input type="text" class="step-timeline" placeholder="Date or timeframe"></td>
                </tr>
                <tr>
                    <td><input type="text" class="step-action" placeholder="Describe specific action"></td>
                    <td><input type="text" class="step-responsible" placeholder="Name or role"></td>
                    <td><input type="text" class="step-timeline" placeholder="Date or timeframe"></td>
                </tr>
            </tbody>
        </table>
        <div class="next-steps-warning">* At least one next step is required (fill at least one field in any row)</div>
    </div>

    <!-- SECTION 7: Decision (Disabled for requester, enabled for manager) -->
    <div class="decision-section section-disabled" id="decisionSection">
        <div class="decision-header">
            <div class="decision-title">
                <span class="section-number">7</span>
                Decision
                <span class="status-indicator status-pending" id="decisionStatusLabel">Awaiting Manager</span>
            </div>
            <div class="decision-date-container">
                <div class="decision-date-label">Decision Date:</div>
                <input type="date" class="decision-date-input" id="decisionDate" disabled>
            </div>
        </div>

        <div class="decision-options">
            <div class="decision-option">
                <input type="radio" id="approved" name="decision" value="approved" disabled>
                <label for="approved">Approved</label>
            </div>
            <div class="decision-option">
                <input type="radio" id="approved-conditions" name="decision" value="approved-conditions" disabled>
                <label for="approved-conditions">Approved with conditions</label>
            </div>
            <div class="decision-option">
                <input type="radio" id="not-approved" name="decision" value="not-approved" disabled>
                <label for="not-approved">Not approved</label>
            </div>
            <div class="decision-option">
                <input type="radio" id="requester-promoted" name="decision" value="requester-promoted" disabled>
                <label for="requester-promoted">Requester promoted to decide</label>
            </div>
        </div>
        <div class="decision-notes">
            <textarea id="decisionNotes" placeholder="Decision notes, conditions, or rationale... (Manager must provide decision and notes)" disabled></textarea>
            <div class="decision-required-warning">* Manager must provide decision and notes</div>
        </div>
        <div class="instructions" style="margin-top: 10px; font-size: 12px;">
            <p><i class="fas fa-lock"></i> <strong>Section Locked:</strong> Only the Decision Owner (Manager) can update this section after the document is saved to cloud.</p>
        </div>
    </div>

    <div class="footer">
        Document ID: <span id="docId">Draft</span> | Generated on <span id="generatedDate"></span>
    </div>
</div>

<!-- First Time Help Modal -->
<div id="firstTimeHelpModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <div class="modal-title" style="color: #3b82f6;">
                <i class="fas fa-rocket"></i> Welcome to Decision Brief!
            </div>
            <button class="close-btn" onclick="closeFirstTimeHelp()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; color: #3b82f6; margin-bottom: 10px;">
                    📋
                </div>
                <h3 style="color: #1e293b; margin-bottom: 10px;">Professional Decision Documentation Made Easy</h3>
                <p style="color: #64748b;">Follow these simple steps to get started</p>
            </div>
            
            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <div style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;">1️⃣</div>
                        <h4 style="margin: 0 0 5px 0; color: #0369a1;">Fill Form</h4>
                        <p style="font-size: 12px; color: #475569; margin: 0;">Complete the decision brief</p>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: #fef3c7; border-radius: 8px;">
                        <div style="font-size: 24px; color: #f59e0b; margin-bottom: 10px;">2️⃣</div>
                        <h4 style="margin: 0 0 5px 0; color: #92400e;">Save to Cloud</h4>
                        <p style="font-size: 12px; color: #475569; margin: 0;">Click "Save to Cloud and Share"</p>
                    </div>
                    
                    <div style="text-align: center; padding: 15px; background: #d1fae5; border-radius: 8px;">
                        <div style="font-size: 24px; color: #10b981; margin-bottom: 10px;">3️⃣</div>
                        <h4 style="margin: 0 0 5px 0; color: #065f46;">Share with Manager</h4>
                        <p style="font-size: 12px; color: #475569; margin: 0;">Email link from success modal</p>
                    </div>
                </div>
            </div>
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h4 style="color: #475569; margin-bottom: 10px;"><i class="fas fa-lightbulb"></i> How It Works:</h4>
                <ul style="margin: 0; padding-left: 20px; color: #64748b; font-size: 13px;">
                    <li><strong>Requester:</strong> Fill Sections 1-6 → Save → Email to Manager</li>
                    <li><strong>Section 7:</strong> Locked for requester, only manager can update</li>
                    <li><strong>Manager:</strong> Receives link → Updates Section 7 → Saves → Emails back to requester</li>
                    <li><strong>Cloud Storage:</strong> FREE GitHub Gists (100% private to your account)</li>
                </ul>
            </div>
            
            <div class="email-actions" style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="closeFirstTimeHelp()" style="padding: 12px 30px;">
                    <i class="fas fa-play-circle"></i> Let's Get Started!
                </button>
                <button class="btn" onclick="showGithubConfigModal(); closeFirstTimeHelp();" style="margin-left: 10px;">
                    <i class="fab fa-github"></i> Setup Cloud First
                </button>
            </div>
            
            <p style="text-align: center; margin-top: 15px; color: #94a3b8; font-size: 12px;">
                <i class="fas fa-info-circle"></i> This message won't show again
            </p>
        </div>
    </div>
</div>

<script>
    // ================================
    // 🔗 GITHUB GIST CONFIGURATION
    // ================================
    const GITHUB_CONFIG_KEY = 'decision_brief_github_config';
    const DOCUMENTS_DB_KEY = 'decision_brief_documents';
    const DASHBOARD_PASSWORD_KEY = 'decision_brief_dashboard_password';
    const USER_ROLE_KEY = 'decision_brief_user_role';
    const TEMPLATE_URL = window.location.href.split('#')[0];

    let githubConfig = {
        token: '',
        gistId: '',
        syncFrequency: 'manual',
        lastSync: null
    };
    
    let documentsDatabase = [];
    let dashboardPassword = null;
    let syncInterval = null;
    
    // Global state
    let currentPdfBlob = null;
    let currentPdfUrl = null;
    let documentUniqueId = null;
    let currentFormData = null;
    let htmlEmailTemplate = '';
    let plainTextTemplate = '';
    
    // Track document state
    let documentSaved = false;
    let section7Filled = false;
    let currentEmailType = 'manager';
    let isManagerMode = false;
    let currentUserRole = 'requester'; // 'requester' or 'manager'
    let isDocumentLoadedFromURL = false;

    // ================================
    // INITIALIZATION
    // ================================
    document.addEventListener("DOMContentLoaded", function () {
        // Load GitHub config
        loadGithubConfig();
        
        // Load documents database
        loadDocumentsDatabase();
        
        // Initialize document
        initializeDocument();
        
        // Setup PDF modal event listeners
        setupPdfModalListeners();
        
        // Setup email modal event listeners
        setupEmailModalListeners();
        
        // Show first-time help (only once)
        setTimeout(() => {
            showFirstTimeHelp();
        }, 1000);
        
        // Load document from URL if present
        setTimeout(() => {
            loadDocumentFromURL();
        }, 500);
        
        // Apply user role based on URL and document state
        applyUserRole();
    });

    function updateUIForRole() {
        const shareViaEmailBtn = document.getElementById('shareViaEmailBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        
        // Update email button text based on role
        if (isManagerMode) {
            shareViaEmailBtn.innerHTML = '<i class="fas fa-envelope"></i> Email to Requester';
            shareViaEmailBtn.title = 'Email decision to requester';
        } else {
            shareViaEmailBtn.innerHTML = '<i class="fas fa-envelope"></i> Email to Manager';
            shareViaEmailBtn.title = 'Email document to manager for review';
        }
        
        // Update PDF button state
        checkDecisionMade();
        
        // Show/hide email button based on document state
        if (documentSaved) {
            shareViaEmailBtn.style.display = 'inline-block';
        } else {
            shareViaEmailBtn.style.display = 'none';
        }
    }

    // ================================
    // AUTO ROLE DETECTION - FIXED VERSION
    // ================================
    function detectUserRole() {
        // Check URL parameters first for explicit role
        const urlParams = new URLSearchParams(window.location.search);
        const roleParam = urlParams.get('role');
        
        // If URL has explicit role parameter, use it
        if (roleParam === 'manager') {
            return 'manager';
        }
        if (roleParam === 'requester') {
            return 'requester';
        }
        
        // Check if document is loaded from URL (shared link)
        const hash = window.location.hash;
        const hasDocumentId = hash.includes('doc=');
        
        // If this is a shared link (has document ID), check document state
        if (hasDocumentId) {
            // Get current decision state from form
            const decisionSelected = document.querySelector('input[name="decision"]:checked');
            const decisionNotes = document.getElementById("decisionNotes").value.trim();
            const isDecisionMade = decisionSelected && decisionNotes.length > 0;
            
            // If decision is already made, this is for requester to view
            // If decision is not made, this is for manager to decide
            return isDecisionMade ? 'requester' : 'manager';
        }
        
        // Default for new documents (no document ID in URL)
        return 'requester';
    }

    function applyUserRole() {
        const detectedRole = detectUserRole();
        currentUserRole = detectedRole;
        localStorage.setItem(USER_ROLE_KEY, currentUserRole);
        
        if (currentUserRole === 'manager') {
            enableManagerMode();
        } else {
            enableRequesterMode();
        }
        
        updateUIForRole();
    }

    function enableManagerMode() {
        isManagerMode = true;
        
        // Enable Section 7 for manager
        const decisionSection = document.getElementById('decisionSection');
        decisionSection.classList.remove('section-disabled');
        
        // Enable all inputs in Section 7
        decisionSection.querySelectorAll('input, textarea, select').forEach(el => {
            el.disabled = false;
        });
        
        // Update status label
        document.getElementById('decisionStatusLabel').textContent = 'Manager Mode';
        document.getElementById('decisionStatusLabel').className = 'status-indicator status-approved';
        
        // Update instructions
        const instructions = document.querySelector('#decisionSection .instructions');
        if (instructions) {
            instructions.innerHTML = '<p><i class="fas fa-unlock"></i> <strong>Manager Mode:</strong> You can update the decision and notes. After saving, use "Share via Email" to send the decision to the requester.</p>';
        }
        
        console.log('Manager mode enabled - Section 7 unlocked');
    }

    function enableRequesterMode() {
        isManagerMode = false;
        
        // Disable Section 7 for requester
        const decisionSection = document.getElementById('decisionSection');
        decisionSection.classList.add('section-disabled');
        
        // Disable all inputs in Section 7
        decisionSection.querySelectorAll('input, textarea, select').forEach(el => {
            el.disabled = true;
        });
        
        // Update status label based on current decision state
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        const decisionNotes = document.getElementById("decisionNotes").value.trim();
        
        if (decisionSelected && decisionNotes.length > 0) {
            // Decision already made, show status
            updateStatusBadge();
        } else {
            document.getElementById('decisionStatusLabel').textContent = 'Awaiting Manager';
            document.getElementById('decisionStatusLabel').className = 'status-indicator status-pending';
        }
        
        // Update instructions
        const instructions = document.querySelector('#decisionSection .instructions');
        if (instructions) {
            instructions.innerHTML = '<p><i class="fas fa-lock"></i> <strong>Section Locked:</strong> Only the Decision Owner (Manager) can update this section after the document is saved to cloud.</p>';
        }
        
        console.log('Requester mode enabled - Section 7 locked');
    }

    function initializeDocument() {
        document.getElementById("generatedDate").textContent = new Date().toLocaleDateString("en-US", {
            year: "numeric", month: "long", day: "numeric"
        });

        const requestDateInput = document.getElementById("requestDate");
        requestDateInput.valueAsDate = new Date();

        const decisionDateInput = document.getElementById("decisionDate");
        decisionDateInput.valueAsDate = new Date();

        generateDocumentId();
        createOptionsGrid();
        initializeScores();
        setupEventListeners();
        updateStatusBadge();
    }

    function generateDocumentId() {
        const timestamp = Date.now();
        const random = Math.floor(Math.random() * 1000);
        documentUniqueId = `DB-${timestamp}-${random}`;
        document.getElementById("docId").textContent = documentUniqueId;
    }

    // ================================
    // ☁️ SAVE TO CLOUD AND SHARE (UPDATED)
    // ================================
    async function saveToCloudAndShare() {
        // Step 1: Validate required fields
        if (!validateAllMandatoryFields()) {
            showAlert('❌ Please fill in all required fields (marked with *) before saving.', 'error');
            
            // Scroll to first missing field
            const firstMissing = document.querySelector('.mandatory-field, .next-steps-mandatory');
            if (firstMissing) {
                firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        // If manager, also validate Section 7
        if (isManagerMode && !checkSection7Complete()) {
            showAlert('❌ As a manager, you must provide a decision and notes in Section 7 before saving.', 'error');
            document.getElementById("decisionSection").scrollIntoView({ behavior: "smooth" });
            return;
        }

        const saveBtn = document.getElementById('saveAndShareBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        saveBtn.disabled = true;

        try {
            // Step 2: Check if GitHub is configured
            if (!githubConfig.token || githubConfig.token.trim() === '') {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                showAlert('🔧 First-Time Setup Required!\n\n1. We\'ll set up FREE cloud storage (GitHub Gists)\n2. All data stays private to your account\n3. Get a shareable link to collaborate\n\nClick OK to continue setup.', 'info');
                
                setTimeout(() => {
                    showGithubConfigModal();
                }, 500);
                return;
            }

            // Step 3: Save to GitHub
            showAlert('💾 Saving to cloud storage...', 'info');
            
            const saved = await saveToGithub(true);
            if (!saved) {
                throw new Error('Failed to save to cloud');
            }

            // Step 4: Save to local database
            const docId = saveDocumentToDatabase();
            const shareUrl = generateDocumentUrl(docId);
            
            // Mark document as saved
            documentSaved = true;
            
            // Update UI
            updateUIForRole();

            // Step 5: Show appropriate success modal based on user role
            setTimeout(() => {
                if (isManagerMode) {
                    showManagerSaveSuccessModal(docId, shareUrl);
                } else {
                    showSaveSuccessModal(docId, shareUrl);
                }
            }, 500);

        } catch (error) {
            console.error('Save & Share error:', error);
            showAlert(`❌ Save Failed: ${error.message}\n\nPlease check your GitHub token or try again.`, 'error');
        } finally {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }

    // ================================
    // 📧 SHARE VIA EMAIL FUNCTION (UNIFIED)
    // ================================
    function openShareViaEmail(forceRecipientType = null) {
        // Make sure document is saved first
        if (!documentSaved) {
            const saveFirst = confirm("Document needs to be saved first. Click OK to save to cloud.");
            if (saveFirst) {
                saveToCloudAndShare().then(() => {
                    // After saving, open email modal
                    setTimeout(() => {
                        openShareViaEmail(forceRecipientType);
                    }, 1000);
                });
                return;
            }
            return;
        }
        
        // Determine recipient type
        let recipientType = forceRecipientType;
        if (!recipientType) {
            recipientType = isManagerMode ? 'requester' : 'manager';
        }
        
        currentEmailType = recipientType;
        
        if (recipientType === 'manager') {
            setupToManagerEmail();
        } else {
            setupToRequesterEmail();
        }

        const emailModal = document.getElementById("emailModal");
        emailModal.style.display = "flex";
        
        // Update email modal buttons based on type
        updateEmailModalButtons(recipientType);
        
        setTimeout(() => {
            const preview = document.getElementById("emailTemplatePreview");
            if (preview) {
                preview.style.display = "none";
                setTimeout(() => { preview.style.display = "block"; }, 10);
            }
        }, 50);
    }

    // ================================
    // 📋 SAVE SUCCESS MODALS
    // ================================
    function showSaveSuccessModal(docId, shareUrl) {
        document.getElementById('successDocId').textContent = docId;
        document.getElementById('successShareLink').value = shareUrl;
        document.getElementById('saveSuccessModal').style.display = 'flex';
    }

    function closeSaveSuccessModal() {
        document.getElementById('saveSuccessModal').style.display = 'none';
    }

    function showManagerSaveSuccessModal(docId, shareUrl) {
        document.getElementById('managerSuccessDocId').textContent = docId;
        document.getElementById('managerSuccessShareLink').value = shareUrl;
        document.getElementById('managerSaveSuccessModal').style.display = 'flex';
    }

    function closeManagerSaveSuccessModal() {
        document.getElementById('managerSaveSuccessModal').style.display = 'none';
    }

    function copySuccessShareLink() {
        const input = document.getElementById('successShareLink');
        input.select();
        document.execCommand('copy');
        
        const btn = input.nextElementSibling;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('copied');
        }, 2000);
        
        showAlert('✅ Document link copied to clipboard!', 'success');
    }

    function copyManagerSuccessShareLink() {
        const input = document.getElementById('managerSuccessShareLink');
        input.select();
        document.execCommand('copy');
        
        const btn = input.nextElementSibling;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('copied');
        }, 2000);
        
        showAlert('✅ Document link copied to clipboard!', 'success');
    }

    function openShareLink() {
        const shareUrl = document.getElementById('successShareLink').value;
        window.open(shareUrl, '_blank');
    }

    function shareLinkViaEmailFromSuccess() {
        openShareViaEmail('manager');
    }

    function shareLinkViaEmailFromManagerSuccess() {
        openShareViaEmail('requester');
    }

    // ================================
    // 📧 EMAIL TEMPLATE FUNCTIONS
    // ================================
    function setupToManagerEmail() {
        // Use current form data
        const topic = document.getElementById("topic").value || "Decision Brief";
        const requester = document.getElementById("requestedBy").value || "Requester";
        const docId = document.getElementById("docId").textContent;
        const decisionOwner = document.getElementById("decisionOwner").value || "Manager";
        const additionalMessage = document.getElementById("additionalMessage").value || "";
        const requesterEmailVal = document.getElementById("requesterEmail").value || "";
        const decisionOwnerEmailVal = document.getElementById("decisionOwnerEmail").value || "";
        const today = new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
        
        // Generate document URL with manager role
        const shareUrl = generateDocumentUrl(docId) + "&role=manager";
        
        const subject = `Decision Brief for Review: ${topic}`;
        document.getElementById("emailSubject").value = subject;

        // Plain text template
        plainTextTemplate = `Dear ${decisionOwner},

I have prepared a Decision Brief that requires your review and decision as per details provided below:

 

1-Mandatory steps to follow upon using the link:

    -Go to Settings and paste your GitHub Personal Access Token in the required field, and (optionally) add the Gist ID.

    -Click Load From Cloud to retrieve the request details.

    -Review all sections carefully and update your decision in Section 7, including any relevant notes.

    -Click Save to Cloud and Share to save the updated document.

    -Finally, select Share via Email to send your completed decision back.

2- Link to the decision brief:
${shareUrl}


Best regards,
${requester}

---
Generated by Decision Brief System on ${today}`;

        // HTML email template
        htmlEmailTemplate = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; line-height: 1.15; margin: 0; padding: 0; }
.container { max-width: 600px; margin: 0 auto; padding: 20px; }
.header { margin-bottom: 20px; }
.details { margin: 15px 0; padding: 15px; background-color: #f8fafc; border-left: 4px solid #1e293b; }
.link-box { margin: 20px 0; padding: 20px; background-color: #eff6ff; border: 1px solid #3b82f6; border-radius: 4px; }
.link-box a { color: #1e40af; text-decoration: none; font-weight: normal; }
.link-box a:hover { text-decoration: underline; }
.instructions { margin: 15px 0; padding: 15px; background-color: #f0f9ff; border-left: 4px solid #0ea5e9; }
.footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 9pt; color: #64748b; }
</style>
</head>
<body>
<div class="container">
<div class="header">
<h2 style="font-family: Calibri, Arial, sans-serif; font-size: 14pt; font-weight: normal; color: #000000; margin: 0 0 10px 0;">Decision Brief - Review Required</h2>
</div>

<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 0 0 15px 0;">Dear ${decisionOwner},</p>

<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 0 0 15px 0;">I have prepared a Decision Brief that requires your review and decision.</p>

<div class="details">
<h3 style="font-family: Calibri, Arial, sans-serif; font-size: 12pt; font-weight: normal; color: #1e293b; margin: 0 0 10px 0;">Document Details</h3>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Topic:</strong> ${topic}</p>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Requested by:</strong> ${requester}</p>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Request Date:</strong> ${today}</p>
</div>

${additionalMessage ? `<div class="details"><p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Additional Notes:</strong><br>${additionalMessage.replace(/\n/g,"<br>")}</p></div>` : ""}

<div class="link-box">
<h3 style="font-family: Calibri, Arial, sans-serif; font-size: 12pt; font-weight: normal; color: #1e40af; margin: 0 0 10px 0;">Access the Decision Brief</h3>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 10px 0;">Please use the following link to access and review the document:</p>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 15px 0; background-color: white; padding: 12px; border-radius: 4px; border: 1px solid #e2e8f0;">
<a href="${shareUrl}" style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #1e40af; text-decoration: none; font-weight: normal;">${shareUrl}</a>
</p>
</div>

<div class="instructions">
<h3 style="font-family: Calibri, Arial, sans-serif; font-size: 12pt; font-weight: normal; color: #0ea5e9; margin: 0 0 10px 0;">Review Instructions</h3>
<ol style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 10px 0; padding-left: 20px;">
<li style="margin-bottom: 5px;">Click the link above to open the Decision Brief</li>
<li style="margin-bottom: 5px;">Review all sections carefully</li>
<li style="margin-bottom: 5px;"><strong>Section 7 will be unlocked for you</strong> - Make your decision and add notes</li>
<li style="margin-bottom: 5px;">Click "Save to Cloud and Share" to save changes</li>
<li style="margin-bottom: 5px;">Use "Share via Email" to send your decision back</li>
</ol>
</div>

<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 20px 0 0 0;">Best regards,<br><strong>${requester}</strong></p>

<div class="footer">
<p style="font-family: Calibri, Arial, sans-serif; font-size: 9pt; color: #64748b; margin: 5px 0; text-align: center;">Generated by Decision Brief System on ${today}</p>
</div>
</body>
</html>`;

        document.getElementById("emailModalTitle").textContent = "Email to Manager";
        document.getElementById("toLabel").textContent = "To (Manager Email)";
        document.getElementById("templateTitle").textContent = "HTML Email Template (Outlook Friendly):";
        const preview = document.getElementById("emailTemplatePreview");
        preview.innerHTML = htmlEmailTemplate;

        if (decisionOwnerEmailVal) document.getElementById("toEmail").value = decisionOwnerEmailVal;
        if (requesterEmailVal) document.getElementById("fromEmail").value = requesterEmailVal;
    }

    function setupToRequesterEmail() {
        const topic = document.getElementById("topic").value || "Decision Brief";
        const requester = document.getElementById("requestedBy").value || "Requester";
        const docId = document.getElementById("docId").textContent;
        const decisionOwner = document.getElementById("decisionOwner").value || "Manager";
        const requesterEmailVal = document.getElementById("requesterEmail").value || "";
        const decisionOwnerEmailVal = document.getElementById("decisionOwnerEmail").value || "";
        const decision = document.querySelector('input[name="decision"]:checked');
        const decisionDate = document.getElementById("decisionDate").value;
        const decisionNotes = document.getElementById("decisionNotes").value || "";
        const additionalMessage = document.getElementById("additionalMessage").value || "";

        let decisionText = "Pending";
        let decisionColor = "#64748b";
        let decisionIcon = "⏳";
        if (decision) {
            switch (decision.value) {
                case "approved": 
                    decisionText = "Approved"; 
                    decisionColor = "#10b981";
                    decisionIcon = "✅";
                    break;
                case "approved-conditions": 
                    decisionText = "Approved with Conditions"; 
                    decisionColor = "#3b82f6";
                    decisionIcon = "✅";
                    break;
                case "not-approved": 
                    decisionText = "Not Approved"; 
                    decisionColor = "#ef4444";
                    decisionIcon = "❌";
                    break;
                case "requester-promoted": 
                    decisionText = "Requester to Decide"; 
                    decisionColor = "#8b5cf6";
                    decisionIcon = "👤";
                    break;
            }
        }

        let formattedDate = "Not specified";
        if (decisionDate) {
            const d = new Date(decisionDate);
            formattedDate = d.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
        }
        const today = new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
        
        // Generate document URL
        const shareUrl = generateDocumentUrl(docId);
        
        const subject = `Decision Brief Decision: ${decisionText} - ${topic}`;
        document.getElementById("emailSubject").value = subject;

        // Plain text template
        plainTextTemplate = `Dear ${requester},

The Decision Brief has been reviewed and a decision has been made.

Decision Brief Details:
• Topic: ${topic}
• Decision: ${decisionIcon} ${decisionText}
• Decision Date: ${formattedDate}
• Decision Owner: ${decisionOwner}

${decisionNotes ? `Decision Notes:\n${decisionNotes}\n\n` : ""}${additionalMessage ? `Additional Message:\n${additionalMessage}\n\n` : ""}You can access the finalized Decision Brief using this link:
${shareUrl}

Click the link above to view the completed Decision Brief with all details.

Best regards,
${decisionOwner}

---
Generated by Decision Brief System on ${today}`;

        // HTML email template
        htmlEmailTemplate = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; line-height: 1.15; margin: 0; padding: 0; }
.container { max-width: 600px; margin: 0 auto; padding: 20px; }
.header { background-color: ${decisionColor}; padding: 20px; border-radius: 4px; margin-bottom: 20px; }
.header h2 { color: white; margin: 0; font-family: Calibri, Arial, sans-serif; font-size: 14pt; font-weight: normal; }
.decision-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-family: Calibri, Arial, sans-serif; font-size: 11pt; font-weight: normal; color: white; background: ${decisionColor}; margin: 5px 0; }
.details { margin: 15px 0; padding: 15px; background-color: #f8fafc; border-left: 4px solid #1e293b; }
.notes { margin: 15px 0; padding: 15px; background-color: #f0f9ff; border-left: 4px solid #0ea5e9; }
.link-box { margin: 20px 0; padding: 20px; background-color: #eff6ff; border: 1px solid #3b82f6; border-radius: 4px; }
.link-box a { color: #1e40af; text-decoration: none; font-weight: normal; }
.link-box a:hover { text-decoration: underline; }
.footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 9pt; color: #64748b; }
</style>
</head>
<body>
<div class="container">
<div class="header">
<h2>${decisionIcon} Decision Brief - Decision Made</h2>
</div>

<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 0 0 15px 0;">Dear ${requester},</p>

<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 0 0 15px 0;">The Decision Brief has been reviewed and a decision has been made.</p>

<div class="details">
<h3 style="font-family: Calibri, Arial, sans-serif; font-size: 12pt; font-weight: normal; color: #1e293b; margin: 0 0 10px 0;">Document Details</h3>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Topic:</strong> ${topic}</p>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Decision:</strong> <span class="decision-badge">${decisionIcon} ${decisionText}</span></p>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Decision Date:</strong> ${formattedDate}</p>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Decision Owner:</strong> ${decisionOwner}</p>
</div>

${decisionNotes ? `<div class="notes">
<h3 style="font-family: Calibri, Arial, sans-serif; font-size: 12pt; font-weight: normal; color: #0ea5e9; margin: 0 0 10px 0;">Decision Notes</h3>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;">${decisionNotes.replace(/\n/g,"<br>")}</p>
</div>` : ""}

${additionalMessage ? `<div class="details"><p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 5px 0;"><strong>Additional Message:</strong><br>${additionalMessage.replace(/\n/g,"<br>")}</p></div>` : ""}

<div class="link-box">
<h3 style="font-family: Calibri, Arial, sans-serif; font-size: 12pt; font-weight: normal; color: #1e40af; margin: 0 0 10px 0;">Access the Decision Brief</h3>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 10px 0;">You can access the finalized Decision Brief using this link:</p>
<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 15px 0; background-color: white; padding: 12px; border-radius: 4px; border: 1px solid #e2e8f0;">
<a href="${shareUrl}" style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #1e40af; text-decoration: none; font-weight: normal;">${shareUrl}</a>
</p>
</div>

<p style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000; margin: 20px 0 0 0;">Best regards,<br><strong>${decisionOwner}</strong></p>

<div class="footer">
<p style="font-family: Calibri, Arial, sans-serif; font-size: 9pt; color: #64748b; margin: 5px 0; text-align: center;">Generated by Decision Brief System on ${today}</p>
</div>
</body>
</html>`;

        document.getElementById("emailModalTitle").textContent = "Email to Requester";
        document.getElementById("toLabel").textContent = "To (Requester Email)";
        document.getElementById("templateTitle").textContent = "HTML Email Template:";
        const preview = document.getElementById("emailTemplatePreview");
        preview.innerHTML = htmlEmailTemplate;

        if (requesterEmailVal) document.getElementById("toEmail").value = requesterEmailVal;
        if (decisionOwnerEmailVal) document.getElementById("fromEmail").value = decisionOwnerEmailVal;
    }

    function updateEmailModalButtons(recipientType) {
        const actionsContainer = document.getElementById("emailModalActions");
        
        actionsContainer.innerHTML = `
            <button class="btn btn-success" onclick="copyHTMLToClipboard()">
                📋 Copy HTML Email
            </button>
            <button class="btn btn-info" onclick="copyPlainTextToClipboard()">
                📋 Copy Plain Text
            </button>
            <button class="btn btn-primary" onclick="openEmailClient()">
                📧 Open Email Client
            </button>
        `;
        
        document.getElementById("emailInstructions").innerHTML = `
            <li><strong>Copy HTML Email</strong> - Best for Outlook/Gmail with full formatting</li>
            <li><strong>Copy Plain Text</strong> - For simple email clients</li>
            <li><strong>Open Email Client</strong> - Opens your default email app</li>
        `;
    }

    function copyHTMLToClipboard() {
        const toEmail = document.getElementById("toEmail").value || "recipient@company.com";
        const fromEmail = document.getElementById("fromEmail").value || "sender@company.com";
        const subject = document.getElementById("emailSubject").value;
        
        let emailHTML = `To: ${toEmail}
From: ${fromEmail}
Subject: ${subject}
Content-Type: text/html; charset=UTF-8
MIME-Version: 1.0

${htmlEmailTemplate}`;
            
        navigator.clipboard.writeText(emailHTML).then(() => {
            showAlert('✅ HTML email copied to clipboard!\n\nPaste into your email client (Outlook/Gmail).\n\nFor Outlook: Use "Insert" → "Attach File" → "Attach as Copy"', 'success');
        });
    }

    function copyPlainTextToClipboard() {
        const toEmail = document.getElementById("toEmail").value || "recipient@company.com";
        const fromEmail = document.getElementById("fromEmail").value || "sender@company.com";
        const subject = document.getElementById("emailSubject").value;
        const emailText = `To: ${toEmail}
From: ${fromEmail}
Subject: ${subject}

${plainTextTemplate}`;
        navigator.clipboard.writeText(emailText).then(() => {
            showAlert('✅ Plain text email copied to clipboard!', 'success');
        });
    }

    function openEmailClient() {
        const toEmail = document.getElementById("toEmail").value;
        const fromEmail = document.getElementById("fromEmail").value || "";
        const subject = document.getElementById("emailSubject").value;
        if (!toEmail) {
            alert("Please enter recipient email address.");
            return;
        }
        let mailtoLink = `mailto:${toEmail}`;
        if (fromEmail) mailtoLink += `?cc=${fromEmail}`;
        mailtoLink += `${fromEmail ? "&" : "?"}subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(plainTextTemplate)}`;
        window.open(mailtoLink, "_blank");
    }

    function useTemplate() {
        if (currentEmailType === 'manager') {
            setupToManagerEmail();
        } else {
            setupToRequesterEmail();
        }
    }

    function setupEmailModalListeners() {
        const emailModal = document.getElementById("emailModal");
        const closeEmailModalBtn = document.getElementById("closeEmailModal");
        closeEmailModalBtn.addEventListener("click", () => {
            emailModal.style.display = "none";
        });
        window.addEventListener("click", e => {
            if (e.target === emailModal) {
                emailModal.style.display = "none";
            }
        });
    }

    // ================================
    // GITHUB FUNCTIONS
    // ================================
    function loadGithubConfig() {
        try {
            const saved = localStorage.getItem(GITHUB_CONFIG_KEY);
            if (saved) {
                githubConfig = JSON.parse(saved);
                updateGithubStatus();
                
                if (githubConfig.syncFrequency !== 'manual' && githubConfig.token) {
                    startAutoSync(parseInt(githubConfig.syncFrequency));
                }
            }
        } catch (error) {
            console.error("Error loading GitHub config:", error);
        }
    }
    
    function saveGithubConfig() {
        try {
            githubConfig.token = document.getElementById('githubToken').value.trim();
            githubConfig.gistId = document.getElementById('gistId').value.trim();
            githubConfig.syncFrequency = document.getElementById('syncFrequency').value;
            
            localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
            
            updateGithubStatus();
            
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            if (githubConfig.syncFrequency !== 'manual' && githubConfig.token) {
                startAutoSync(parseInt(githubConfig.syncFrequency));
            }
            
            const statusEl = document.getElementById('configStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#e8f5e9';
            statusEl.style.color = '#2e7d32';
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Configuration saved!';
            
            setTimeout(() => {
                closeGithubConfig();
            }, 1500);
            
        } catch (error) {
            console.error("Error saving GitHub config:", error);
            const statusEl = document.getElementById('configStatus');
            statusEl.style.display = 'block';
            statusEl.style.background = '#ffebee';
            statusEl.style.color = '#c62828';
            statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error saving configuration';
        }
    }
    
    function updateGithubStatus() {
        const statusEl = document.getElementById('githubStatus');
        if (!statusEl) return;
        
        if (githubConfig.token) {
            statusEl.className = 'github-status status-connected';
            statusEl.innerHTML = `<i class="fas fa-cloud"></i> Cloud: Connected`;
            statusEl.style.display = 'inline-flex';
            
            document.getElementById('loadFromGithubBtn').disabled = false;
        } else {
            statusEl.className = 'github-status status-disconnected';
            statusEl.innerHTML = '<i class="fas fa-cloud-slash"></i> Cloud: Not Setup';
            statusEl.style.display = 'inline-flex';
            
            document.getElementById('loadFromGithubBtn').disabled = true;
        }
    }
    
    function startAutoSync(minutes) {
        if (syncInterval) clearInterval(syncInterval);
        
        syncInterval = setInterval(() => {
            console.log(`Auto-syncing to GitHub...`);
            saveToGithub(true);
        }, minutes * 60 * 1000);
        
        console.log(`Auto-sync started: every ${minutes} minutes`);
    }
    
    async function saveToGithub(silent = false) {
        if (!githubConfig.token) {
            if (!silent) {
                showAlert('Please setup GitHub token first! Click the GitHub config button.', 'error');
                showGithubConfigModal();
            }
            return false;
        }
        
        try {
            if (!silent) {
                showAlert('💾 Saving to GitHub Cloud...', 'info');
            }
            
            const data = collectFormData();
            currentFormData = data;
            
            if (!documentUniqueId) {
                generateDocumentId();
            }
            
            // Create current document object
            const currentDoc = {
                id: documentUniqueId,
                data: data,
                timestamp: new Date().toISOString(),
                title: data.Topic || 'Untitled Decision Brief',
                requester: data.RequestedBy || 'Unknown',
                decisionOwner: data.DecisionOwner || 'Unknown',
                status: data.DecisionStatusText || 'Draft',
                userRole: currentUserRole,
                isManagerMode: isManagerMode
            };
            
            // Try to load existing Gist data first
            let existingDocuments = [];
            let existingGistId = githubConfig.gistId;
            
            if (existingGistId && existingGistId.trim() !== '') {
                try {
                    const response = await fetch(`https://api.github.com/gists/${existingGistId}`, {
                        headers: {
                            'Authorization': `Bearer ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const existingGist = await response.json();
                        const fileContent = existingGist.files['decision-brief-data.json'].content;
                        const existingData = JSON.parse(fileContent);
                        
                        // Check if it's the new multi-document format
                        if (existingData.documents && Array.isArray(existingData.documents)) {
                            existingDocuments = existingData.documents;
                        } else if (existingData.data) {
                            // Convert old single document format to new array format
                            existingDocuments = [{
                                id: existingData.documentUniqueId || existingData.data.DocId,
                                data: existingData.data,
                                timestamp: existingData.exportedAt || new Date().toISOString(),
                                title: existingData.data.Topic || 'Untitled'
                            }];
                        }
                    }
                } catch (e) {
                    console.log('No existing Gist or error loading, will create new:', e.message);
                }
            }
            
            // Remove existing document with same ID (if any)
            existingDocuments = existingDocuments.filter(doc => doc.id !== documentUniqueId);
            
            // Add current document
            existingDocuments.push(currentDoc);
            
            // Prepare the new data structure for the Gist
            const allData = {
                app: "Decision Brief",
                version: "1.2",
                exportedAt: new Date().toISOString(),
                documents: existingDocuments,
                gistFormat: "multi-document"
            };
            
            const gistData = {
                description: `Decision Brief - ${currentDoc.title} - Updated ${new Date().toLocaleDateString()}`,
                public: false,
                files: {
                    "decision-brief-data.json": {
                        content: JSON.stringify(allData, null, 2)
                    }
                }
            };
            
            let response;
            let isNewGist = false;
            
            if (existingGistId && existingGistId.trim() !== '') {
                response = await fetch(`https://api.github.com/gists/${existingGistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
            } else {
                response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
                isNewGist = true;
            }
            
            const result = await response.json();
            
            if (response.ok) {
                if (isNewGist && result.id) {
                    githubConfig.gistId = result.id;
                    localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                    
                    if (document.getElementById('gistId')) {
                        document.getElementById('gistId').value = result.id;
                    }
                }
                
                githubConfig.lastSync = new Date().toISOString();
                localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                
                updateGithubStatus();
                
                if (!silent) {
                    const stats = {
                        topic: data.Topic || 'Untitled',
                        requester: data.RequestedBy || 'Unknown',
                        decisionOwner: data.DecisionOwner || 'Unknown',
                        documents: data.Documents ? data.Documents.length : 0,
                        nextSteps: data.NextSteps ? data.NextSteps.length : 0
                    };
                    
                    const message = `✅ DATA SAVED SUCCESSFULLY!

📊 Decision Brief Saved:
• Topic: ${stats.topic}
• Requested by: ${stats.requester}
• Decision Owner: ${stats.decisionOwner}
• Document ID: ${documentUniqueId}
• User Role: ${currentUserRole}
• Documents: ${stats.documents}
• Next Steps: ${stats.nextSteps}

${isNewGist ? '🔗 NEW Gist ID: ' + githubConfig.gistId : '🔗 Gist ID: ' + githubConfig.gistId}
⏰ Time: ${new Date().toLocaleTimeString()}`;
                    
                    showAlert(message, 'success');
                }
                
                return true;
            } else {
                const error = result.message || `HTTP ${response.status}: Failed to save`;
                console.error('GitHub API error:', error);
                throw new Error(error);
            }
            
        } catch (error) {
            console.error('GitHub save error:', error);
            if (!silent) {
                showAlert(`❌ SAVE FAILED: ${error.message}`, 'error');
            }
            return false;
        }
    }
    
    async function loadFromGithub() {
        if (!githubConfig.token) {
            showAlert('Please setup GitHub token first! Click the GitHub config button.', 'error');
            showGithubConfigModal();
            return;
        }

        // Get document ID to load
        const docIdToLoad = getDocIdFromURL() || documentUniqueId || document.getElementById("docId").textContent;
        
        if (!githubConfig.gistId || githubConfig.gistId.trim() === '') {
            showAlert('No Gist ID configured. Save to GitHub first to create a Gist.', 'error');
            return;
        }

        await loadFromGist(githubConfig.gistId, docIdToLoad);
    }
    
    async function loadFromGist(gistId, specificDocId = null) {
        if (!githubConfig.token) {
            showAlert('Please setup GitHub token first! Click the GitHub config button.', 'error');
            showGithubConfigModal();
            return;
        }

        try {
            console.log('Loading from GitHub Gist:', gistId);
            
            showAlert('🔄 Loading from GitHub Cloud...', 'info');
            
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: {
                    'Authorization': `Bearer ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || `HTTP ${response.status}: Failed to load`);
            }
            
            const gist = await response.json();
            
            if (!gist.files || !gist.files['decision-brief-data.json']) {
                throw new Error('No decision-brief-data.json file found in Gist');
            }
            
            const fileContent = gist.files['decision-brief-data.json'].content;
            const importedData = JSON.parse(fileContent);
            
            let documentToLoad = null;
            const docIdToLoad = specificDocId || getDocIdFromURL() || documentUniqueId || document.getElementById("docId").textContent;
            
            // Check the format of the Gist data
            if (importedData.gistFormat === "multi-document" && importedData.documents) {
                // NEW FORMAT: Array of documents
                documentToLoad = importedData.documents.find(doc => doc.id === docIdToLoad);
                
                if (!documentToLoad) {
                    // If not found, show available documents
                    const availableDocs = importedData.documents.map(d => `${d.title} (${d.id})`).join('\n• ');
                    throw new Error(`Document with ID "${docIdToLoad}" not found in Gist.\n\nAvailable documents:\n• ${availableDocs || 'None'}`);
                }
            } else if (importedData.data) {
                // OLD FORMAT: Single document (for backward compatibility)
                const oldDocId = importedData.documentUniqueId || importedData.data.DocId;
                if (oldDocId === docIdToLoad || docIdToLoad === 'Draft') {
                    documentToLoad = {
                        id: oldDocId,
                        data: importedData.data
                    };
                } else {
                    throw new Error(`Document ID mismatch. Requested: "${docIdToLoad}", Found: "${oldDocId}"`);
                }
            } else {
                throw new Error('Invalid data format in Gist');
            }
            
            if (documentToLoad) {
                // Populate form with loaded data
                populateForm(documentToLoad.data);
                currentFormData = documentToLoad.data;
                documentUniqueId = documentToLoad.id;
                document.getElementById("docId").textContent = documentToLoad.id;
                
                // Update document state
                documentSaved = true;
                
                // Apply user role based on loaded document state
                applyUserRole();
                
                // Update gistId in config if different
                if (githubConfig.gistId !== gistId) {
                    githubConfig.gistId = gistId;
                    localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                }
                
                githubConfig.lastSync = new Date().toISOString();
                localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                
                showAlert(`✅ DATA LOADED SUCCESSFULLY!

📊 Loaded Decision Brief:
• Topic: ${documentToLoad.data.Topic || 'Untitled'}
• Document ID: ${documentToLoad.id}
• User Role: ${currentUserRole}

⏰ Last Saved: ${new Date(importedData.exportedAt).toLocaleString() || 'Unknown'}

✅ Form data restored!`, 'success');
                
                updateStatusBadge();
                validateAllMandatoryFields();
                updateUIForRole();
            }
            
        } catch (error) {
            console.error('GitHub load error:', error);
            
            let errorMsg = `❌ Error loading from GitHub: ${error.message}`;
            
            if (error.message.includes('401') || error.message.includes('403')) {
                errorMsg += '\n\n🔑 Token may be invalid or expired. Generate a new token.';
            } else if (error.message.includes('404')) {
                errorMsg += '\n\n🔗 Gist not found. Check Gist ID or save data first.';
            } else if (error.message.includes('JSON')) {
                errorMsg += '\n\n📄 Invalid data format in Gist.';
            }
            
            showAlert(errorMsg, 'error');
        }
    }
    
    // Helper function to get DocId from URL
    function getDocIdFromURL() {
        const hash = window.location.hash;
        if (hash.startsWith('#doc=')) {
            return hash.split('=')[1];
        }
        return null;
    }
    
    function loadDocumentFromURL() {
        const hash = window.location.hash;
        if (hash.startsWith('#doc=')) {
            const docId = hash.split('=')[1];
            isDocumentLoadedFromURL = true;
            
            // Auto-detect role based on URL
            applyUserRole();
            
            // Show message about loading
            showAlert(`📋 Document ID detected: ${docId}\n\nClick "Load from Cloud" to load this specific document.`, 'info');
        }
    }
    
    function showGithubConfigModal() {
        const modal = document.getElementById('githubConfigModal');
        modal.style.display = 'flex';
        
        document.getElementById('githubToken').value = githubConfig.token || '';
        document.getElementById('gistId').value = githubConfig.gistId || '';
        document.getElementById('syncFrequency').value = githubConfig.syncFrequency || 'manual';
    }
    
    function closeGithubConfig() {
        document.getElementById('githubConfigModal').style.display = 'none';
        document.getElementById('configStatus').style.display = 'none';
    }

    // ================================
    // 📁 DOCUMENT MANAGEMENT SYSTEM
    // ================================
    function loadDocumentsDatabase() {
        try {
            const saved = localStorage.getItem(DOCUMENTS_DB_KEY);
            if (saved) {
                documentsDatabase = JSON.parse(saved);
            }
        } catch (error) {
            console.error("Error loading documents database:", error);
            documentsDatabase = [];
        }
        
        // Load dashboard password
        const savedPassword = localStorage.getItem(DASHBOARD_PASSWORD_KEY);
        if (savedPassword) {
            dashboardPassword = savedPassword;
        }
    }

    function saveDocumentsDatabase() {
        try {
            localStorage.setItem(DOCUMENTS_DB_KEY, JSON.stringify(documentsDatabase));
        } catch (error) {
            console.error("Error saving documents database:", error);
        }
    }

    function generateDocumentUrl(docId = null) {
        if (!docId) {
            docId = document.getElementById("docId").textContent;
        }
        
        const baseUrl = window.location.href.split('#')[0];
        return `${baseUrl}#doc=${docId}`;
    }

    function saveDocumentToDatabase() {
        const docId = document.getElementById("docId").textContent;
        const data = collectFormData();
        const timestamp = new Date().toISOString();
        
        // Remove existing entry if any
        documentsDatabase = documentsDatabase.filter(doc => doc.id !== docId);
        
        // Add new entry
        documentsDatabase.push({
            id: docId,
            data: data,
            timestamp: timestamp,
            title: data.Topic || 'Untitled Decision Brief',
            requester: data.RequestedBy || 'Unknown',
            decisionOwner: data.DecisionOwner || 'Unknown',
            status: data.DecisionStatusText || 'Draft',
            lastModified: timestamp,
            gistId: githubConfig.gistId || null,
            userRole: currentUserRole,
            isManagerMode: isManagerMode
        });
        
        // Sort by timestamp (newest first)
        documentsDatabase.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Keep only last 100 documents
        if (documentsDatabase.length > 100) {
            documentsDatabase = documentsDatabase.slice(0, 100);
        }
        
        saveDocumentsDatabase();
        
        return docId;
    }

    // ================================
    // 🔐 PASSWORD-PROTECTED DASHBOARD
    // ================================
    function openDashboard() {
        saveDocumentToDatabase();
        
        if (!dashboardPassword) {
            showDashboard();
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-lock"></i> Dashboard Access
                    </div>
                    <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Enter Dashboard Password</label>
                        <input type="password" class="form-input" id="dashboardPasswordInput" placeholder="Enter password">
                    </div>
                    
                    <div class="email-actions" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="checkDashboardPassword()" style="width: 100%;">
                            <i class="fas fa-unlock"></i> Unlock Dashboard
                        </button>
                    </div>
                    
                    <div class="instructions" style="margin-top: 15px;">
                        <p><strong>Forgot password?</strong> Clear browser data or <button class="btn btn-sm" onclick="resetDashboardPassword()" style="padding: 2px 8px; font-size: 12px;">Reset Password</button></p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function checkDashboardPassword() {
        const input = document.getElementById('dashboardPasswordInput');
        const enteredPassword = input.value.trim();
        
        if (enteredPassword === dashboardPassword) {
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
            showDashboard();
        } else {
            showAlert('❌ Incorrect password. Please try again.', 'error');
            input.value = '';
            input.focus();
        }
    }

    function resetDashboardPassword() {
        if (confirm('Reset dashboard password? This will remove password protection.')) {
            localStorage.removeItem(DASHBOARD_PASSWORD_KEY);
            dashboardPassword = null;
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
            showDashboard();
        }
    }

    function showDashboard() {
        loadDocumentsDatabase();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-tachometer-alt"></i> Documents Dashboard
                        <span style="font-size: 12px; color: #666; margin-left: 10px;">
                            ${documentsDatabase.length} document(s)
                        </span>
                    </div>
                    <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="setupDashboardPassword()">
                            <i class="fas fa-lock"></i> ${dashboardPassword ? 'Change Password' : 'Set Password'}
                        </button>
                        <button class="btn btn-info" onclick="exportAllDocuments()">
                            <i class="fas fa-download"></i> Export All
                        </button>
                        <button class="btn btn-danger" onclick="clearAllDocuments()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                        <button class="btn btn-warning" onclick="toggleUserRole()">
                            <i class="fas fa-user-shield"></i> Switch to ${currentUserRole === 'requester' ? 'Manager' : 'Requester'}
                        </button>
                    </div>
                    
                    <div id="documentsListContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px;">
                        ${documentsDatabase.length === 0 ? 
                            '<div style="text-align: center; padding: 40px; color: #64748b;"><i class="fas fa-folder-open fa-2x"></i><p style="margin-top: 10px;">No documents saved yet</p></div>' : 
                            generateDocumentsListHTML()}
                    </div>
                    
                    <div class="instructions" style="margin-top: 20px;">
                        <p><strong>Dashboard Features:</strong></p>
                        <ul>
                            <li><strong>Password Protection</strong> - Secure your documents</li>
                            <li><strong>Quick Access</strong> - Load any document instantly</li>
                            <li><strong>Export All</strong> - Backup all documents as JSON</li>
                            <li><strong>Switch Role</strong> - Toggle between requester and manager view</li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function generateDocumentsListHTML() {
        if (documentsDatabase.length === 0) return '';
        
        let html = '<table class="dashboard-table">';
        html += `
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Requester</th>
                    <th>Status</th>
                    <th>Role</th>
                    <th>Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
        `;
        
        documentsDatabase.forEach((doc, index) => {
            const date = new Date(doc.lastModified).toLocaleDateString();
            const statusClass = getStatusClass(doc.status);
            const roleBadge = doc.userRole === 'manager' ? 
                '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">Manager</span>' :
                '<span style="background: #64748b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">Requester</span>';
            
            html += `
                <tr>
                    <td>
                        <strong>${doc.title || 'Untitled'}</strong><br>
                        <small style="color: #64748b; font-family: monospace;">${doc.id}</small>
                    </td>
                    <td>${doc.requester}</td>
                    <td>
                        <span class="status-indicator ${statusClass}" style="display: inline-block; padding: 2px 8px; font-size: 11px;">
                            ${doc.status}
                        </span>
                    </td>
                    <td>${roleBadge}</td>
                    <td style="color: #64748b; font-size: 12px;">${date}</td>
                    <td>
                        <button class="btn btn-sm" onclick="loadDocumentFromDashboard('${doc.id}')" style="padding: 4px 8px; font-size: 12px; margin: 2px;">
                            <i class="fas fa-edit"></i> Load
                        </button>
                        <button class="btn btn-sm" onclick="shareDocumentFromDashboard('${doc.id}')" style="padding: 4px 8px; font-size: 12px; margin: 2px; background: #3b82f6; color: white;">
                            <i class="fas fa-share"></i> Share
                        </button>
                        <button class="btn btn-sm" onclick="deleteDocumentFromDashboard('${doc.id}')" style="padding: 4px 8px; font-size: 12px; margin: 2px; background: #ef4444; color: white;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        return html;
    }

    function getStatusClass(status) {
        switch(status.toLowerCase()) {
            case 'approved': return 'status-approved';
            case 'approved with conditions': return 'status-conditional';
            case 'not approved': return 'status-rejected';
            case 'requester to decide': return 'status-promoted';
            case 'draft': return 'status-pending';
            default: return '';
        }
    }

    function loadDocumentFromDashboard(docId) {
        const doc = documentsDatabase.find(d => d.id === docId);
        if (doc) {
            populateForm(doc.data);
            documentUniqueId = docId;
            document.getElementById("docId").textContent = docId;
            
            // Update document state
            documentSaved = true;
            
            // Apply user role based on loaded document
            applyUserRole();
            
            // If document has gistId, update config
            if (doc.gistId && doc.gistId !== githubConfig.gistId) {
                githubConfig.gistId = doc.gistId;
                localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
                updateGithubStatus();
            }
            
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
            
            updateUIForRole();
            
            showAlert(`✅ Document loaded: ${doc.title || 'Untitled'}`, 'success');
        }
    }

    function shareDocumentFromDashboard(docId) {
        const doc = documentsDatabase.find(d => d.id === docId);
        if (doc) {
            const shareUrl = generateDocumentUrl(docId);
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-share-alt"></i> Share Document
                        </div>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    
                    <div class="modal-body">
                        <p><strong>${doc.title || 'Untitled Document'}</strong></p>
                        <p style="color: #666; font-size: 13px; margin: 10px 0;">
                            Document ID: ${docId}<br>
                            Created: ${new Date(doc.timestamp).toLocaleDateString()}
                        </p>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label class="form-label">Shareable Link</label>
                            <div class="share-link-container">
                                <input type="text" class="share-link-input" id="dashboardShareLink" value="${shareUrl}" readonly>
                                <button class="copy-btn" onclick="copyDashboardShareLink()">Copy</button>
                            </div>
                        </div>
                        
                        <div class="email-actions" style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="shareDashboardLinkViaEmail('${shareUrl}')">
                                <i class="fas fa-envelope"></i> Share via Email
                            </button>
                            <button class="btn btn-info" onclick="loadDocumentFromDashboard('${docId}')">
                                <i class="fas fa-edit"></i> Load Document
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    }

    function copyDashboardShareLink() {
        const input = document.getElementById('dashboardShareLink');
        input.select();
        document.execCommand('copy');
        
        const btn = input.nextElementSibling;
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('copied');
        }, 2000);
        
        showAlert('✅ Document link copied!', 'success');
    }

    function shareDashboardLinkViaEmail(shareUrl) {
        const doc = documentsDatabase.find(d => d.id === documentUniqueId);
        const subject = `Decision Brief: ${doc?.title || 'Document'}`;
        
        const emailBody = `Hello,

I'm sharing a Decision Brief with you:

📋 ${doc?.title || 'Decision Brief'}
🔗 View Link: ${shareUrl}

Click the link above to view the Decision Brief in your browser. The form will automatically load with all the data.

Best regards`;
        
        const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        window.open(mailtoLink, '_blank');
    }

    function deleteDocumentFromDashboard(docId) {
        if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
            documentsDatabase = documentsDatabase.filter(doc => doc.id !== docId);
            saveDocumentsDatabase();
            
            const container = document.getElementById('documentsListContainer');
            if (container) {
                container.innerHTML = documentsDatabase.length === 0 ? 
                    '<div style="text-align: center; padding: 40px; color: #64748b;"><i class="fas fa-folder-open fa-2x"></i><p style="margin-top: 10px;">No documents saved yet</p></div>' : 
                    generateDocumentsListHTML();
            }
            
            showAlert('✅ Document deleted!', 'success');
        }
    }

    function setupDashboardPassword() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-lock"></i> ${dashboardPassword ? 'Change Dashboard Password' : 'Set Dashboard Password'}
                    </div>
                    <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">${dashboardPassword ? 'New Password' : 'Set Password'}</label>
                        <input type="password" class="form-input" id="newPasswordInput" placeholder="Enter password">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-input" id="confirmPasswordInput" placeholder="Confirm password">
                    </div>
                    
                    ${dashboardPassword ? `
                    <div class="form-group">
                        <label class="form-label">Current Password (Required to change)</label>
                        <input type="password" class="form-input" id="currentPasswordInput" placeholder="Enter current password">
                    </div>
                    ` : ''}
                    
                    <div class="email-actions" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveDashboardPassword()" style="width: 100%;">
                            <i class="fas fa-save"></i> Save Password
                        </button>
                    </div>
                    
                    <div class="instructions" style="margin-top: 15px;">
                        <p><strong>Note:</strong> Password is stored locally in your browser. If you forget it, you can reset it from the password prompt.</p>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    function saveDashboardPassword() {
        const newPassword = document.getElementById('newPasswordInput').value.trim();
        const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();
        
        if (dashboardPassword) {
            const currentPassword = document.getElementById('currentPasswordInput').value.trim();
            if (currentPassword !== dashboardPassword) {
                showAlert('❌ Current password is incorrect.', 'error');
                return;
            }
        }
        
        if (!newPassword) {
            showAlert('❌ Please enter a password.', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showAlert('❌ Passwords do not match.', 'error');
            return;
        }
        
        dashboardPassword = newPassword;
        localStorage.setItem(DASHBOARD_PASSWORD_KEY, dashboardPassword);
        
        document.querySelectorAll('.modal').forEach(modal => modal.remove());
        
        showAlert(`✅ Dashboard password ${dashboardPassword ? 'changed' : 'set'} successfully!`, 'success');
    }

    function exportAllDocuments() {
        const exportData = {
            app: "Decision Brief Dashboard Export",
            version: "1.0",
            exportedAt: new Date().toISOString(),
            documentCount: documentsDatabase.length,
            documents: documentsDatabase
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const dataUrl = URL.createObjectURL(dataBlob);
        
        const date = new Date().toISOString().split('T')[0];
        const filename = `decision_briefs_backup_${date}.json`;
        
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert(`✅ Exported ${documentsDatabase.length} document(s) to ${filename}`, 'success');
    }

    function clearAllDocuments() {
        if (confirm('Are you sure you want to delete ALL documents? This action cannot be undone.')) {
            documentsDatabase = [];
            saveDocumentsDatabase();
            
            const container = document.getElementById('documentsListContainer');
            if (container) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;"><i class="fas fa-folder-open fa-2x"></i><p style="margin-top: 10px;">No documents saved yet</p></div>';
            }
            
            showAlert('✅ All documents cleared!', 'success');
        }
    }

    function toggleUserRole() {
        currentUserRole = currentUserRole === 'requester' ? 'manager' : 'requester';
        localStorage.setItem(USER_ROLE_KEY, currentUserRole);
        
        if (currentUserRole === 'manager') {
            enableManagerMode();
        } else {
            enableRequesterMode();
        }
        
        updateUIForRole();
        showAlert(`Switched to ${currentUserRole} mode`, 'info');
    }

    // ================================
    // 🆕 FIRST-TIME HELP MODAL
    // ================================
    function showFirstTimeHelp() {
        const hasSeenHelp = localStorage.getItem('decision_brief_help_seen');
        if (!hasSeenHelp) {
            setTimeout(() => {
                document.getElementById('firstTimeHelpModal').style.display = 'flex';
                localStorage.setItem('decision_brief_help_seen', 'true');
            }, 1000);
        }
    }

    function closeFirstTimeHelp() {
        document.getElementById('firstTimeHelpModal').style.display = 'none';
    }

    // ================================
    // PDF FUNCTIONS
    // ================================
    function setupPdfModalListeners() {
        const closePdfModalBtn = document.getElementById("closePdfModal");
        const downloadPdfBtn = document.getElementById("downloadPdfBtn");

        closePdfModalBtn.addEventListener("click", () => {
            document.getElementById("pdfModal").style.display = "none";
        });

        window.addEventListener("click", e => {
            if (e.target === document.getElementById("pdfModal")) {
                document.getElementById("pdfModal").style.display = "none";
            }
        });

        downloadPdfBtn.addEventListener("click", function() {
            if (currentPdfBlob && currentPdfUrl) {
                const docId = document.getElementById("docId").textContent;
                const topic = document.getElementById("topic").value || "Decision_Brief";
                const cleanTopic = topic.replace(/[^a-zA-Z0-9]/g, "_").substring(0, 30);
                const filename = `Decision_Brief_${cleanTopic}_${docId}.pdf`;
                
                const link = document.createElement("a");
                link.href = currentPdfUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert(`✅ PDF downloaded: ${filename}`, 'success');
            }
        });
    }

    async function generatePDF() {
        if (!checkDecisionMade()) {
            alert("Please make a decision and provide notes before generating PDF.");
            document.getElementById("decisionSection").scrollIntoView({ behavior: "smooth" });
            return;
        }

        const pdfBtn = document.getElementById("generatePdfBtn");
        const originalText = pdfBtn.textContent;
        pdfBtn.textContent = "Generating PDF...";
        pdfBtn.disabled = true;

        try {
            await saveToGithub(true);

            const element = document.getElementById("contentToPrint");
            const originalScrollY = window.scrollY;
            window.scrollTo(0, 0);

            const canvas = await html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: "#ffffff"
            });

            window.scrollTo(0, originalScrollY);

            const imgData = canvas.toDataURL("image/png");
            const pdf = new jspdf.jsPDF({
                orientation: "portrait",
                unit: "mm",
                format: "a4",
                compress: true
            });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            const imgWidth = pdfWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let heightLeft = imgHeight;
            let position = 0;

            if (imgHeight <= pdfHeight) {
                pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight, "", "FAST");
            } else {
                while (heightLeft > 0) {
                    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight, "", "FAST");
                    heightLeft -= pdfHeight;
                    if (heightLeft > 0) {
                        pdf.addPage();
                        position -= pdfHeight;
                    }
                }
            }

            const docId = document.getElementById("docId").textContent;
            const date = new Date().toLocaleDateString();
            pdf.setFontSize(8);
            pdf.setTextColor(128, 128, 128);
            pdf.text(
                `Decision Brief: ${docId} | Generated: ${date}`,
                10,
                pdfHeight - 5
            );

            currentPdfBlob = pdf.output("blob");
            currentPdfUrl = URL.createObjectURL(currentPdfBlob);

            document.getElementById("pdfModal").style.display = "flex";

        } catch (error) {
            console.error("Error generating PDF:", error);
            alert("Error generating PDF. Please try again.");
        } finally {
            pdfBtn.textContent = originalText;
            pdfBtn.disabled = false;
        }
    }

    // ================================
    // EXISTING FORM FUNCTIONS
    // ================================
    function createOptionsGrid() {
        const optionsGrid = document.getElementById("optionsGrid");
        const criteria = [
            { name: "Cost", desc: "Financial impact and budget" },
            { name: "Time", desc: "Implementation timeline" },
            { name: "Risk", desc: "Potential risks and mitigation" },
            { name: "People", desc: "Team and organizational impact" },
            { name: "Compliance", desc: "Legal and regulatory requirements" }
        ];

        const optionTemplates = [
            { name: "Option A", desc: "Baseline / Maintain status quo" },
            { name: "Option B", desc: "Recommended approach" },
            { name: "Option C", desc: "Alternative solution" }
        ];

        optionTemplates.forEach((option, index) => {
            const optionCard = document.createElement("div");
            optionCard.className = "option-card";
            optionCard.dataset.optionIndex = index;

            let criteriaHTML = "";
            criteria.forEach((criterion, critIndex) => {
                criteriaHTML += `
                    <tr>
                        <td class="criteria-label">${criterion.name}</td>
                        <td class="criteria-score">
                            <select class="score-select" data-criterion="${critIndex}">
                                <option value="0">-</option>
                                <option value="1">1 (Best)</option>
                                <option value="2">2</option>
                                <option value="3">3 (Average)</option>
                                <option value="4">4</option>
                                <option value="5">5 (Worst)</option>
                            </select>
                        </td>
                    </tr>
                `;
            });

            optionCard.innerHTML = `
                <div class="option-header">
                    <div class="option-name">${option.name}</div>
                    <div class="score-display">Score: <span class="score-value">0</span></div>
                </div>
                <div class="option-input">
                    <input type="text" class="option-title" data-field="title" value="${option.name}" placeholder="Option name">
                </div>
                <div class="option-input">
                    <input type="text" class="option-description" data-field="description" value="${option.desc}" placeholder="Brief description">
                </div>
                <table class="criteria-table">
                    <tbody>${criteriaHTML}</tbody>
                </table>
            `;
            optionsGrid.appendChild(optionCard);
        });
    }

    function calculateScore(optionCard) {
        const scoreSelects = optionCard.querySelectorAll(".score-select");
        let totalScore = 0;
        scoreSelects.forEach(select => {
            totalScore += parseInt(select.value) || 0;
        });

        const scoreDisplay = optionCard.querySelector(".score-display");
        const scoreValue = optionCard.querySelector(".score-value");
        scoreValue.textContent = totalScore;

        if (totalScore <= 10) scoreDisplay.style.background = "#10b981";
        else if (totalScore <= 15) scoreDisplay.style.background = "#f59e0b";
        else if (totalScore > 15) scoreDisplay.style.background = "#ef4444";
        else scoreDisplay.style.background = "#1e293b";

        return totalScore;
    }

    function initializeScores() {
        document.querySelectorAll(".option-card").forEach(card => {
            calculateScore(card);
            card.querySelectorAll(".score-select").forEach(select => {
                select.addEventListener("change", () => calculateScore(card));
            });
        });
    }

    function setupEventListeners() {
        document.querySelectorAll('input[name="decision"]').forEach(radio => {
            radio.addEventListener("change", function () {
                updateStatusBadge();
                checkDecisionMade();
            });
        });

        document.getElementById("decisionNotes").addEventListener("input", function() {
            checkDecisionMade();
        });
        
        document.getElementById("decisionDate").addEventListener("change", updateStatusBadge);

        // Add listeners to all form fields to update UI
        const mandatoryFields = ["topic", "requestedBy", "decisionOwner", "background", "decisionRequired", "recommendation"];
        mandatoryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field) return;
            field.addEventListener("input", () => {
                validateMandatoryField(fieldId);
            });
            field.addEventListener("blur", () => validateMandatoryField(fieldId));
        });

        document.querySelectorAll(".step-action, .step-responsible, .step-timeline").forEach(input => {
            input.addEventListener("input", () => {
                validateNextSteps();
            });
            input.addEventListener("blur", validateNextSteps);
        });

        window.addEventListener("click", e => {
            const githubModal = document.getElementById('githubConfigModal');
            if (e.target === githubModal) {
                closeGithubConfig();
            }
        });
        
        window.addEventListener("click", e => {
            const firstTimeModal = document.getElementById('firstTimeHelpModal');
            if (e.target === firstTimeModal) {
                closeFirstTimeHelp();
            }
        });
    }

    function validateMandatoryField(fieldId) {
        const field = document.getElementById(fieldId);
        const fieldContainer = document.getElementById(fieldId + "Field");
        if (!field || !fieldContainer) return;
        if (!field.value.trim()) fieldContainer.classList.add("mandatory-field");
        else fieldContainer.classList.remove("mandatory-field");
    }

    function validateNextSteps() {
        const stepActions = document.querySelectorAll(".step-action");
        const stepResponsibles = document.querySelectorAll(".step-responsible");
        const stepTimelines = document.querySelectorAll(".step-timeline");
        const nextStepsSection = document.getElementById("nextStepsSection");
        let hasAtLeastOneStep = false;

        for (let i = 0; i < stepActions.length; i++) {
            if (stepActions[i].value.trim() || stepResponsibles[i].value.trim() || stepTimelines[i].value.trim()) {
                hasAtLeastOneStep = true;
                break;
            }
        }
        if (!hasAtLeastOneStep) nextStepsSection.classList.add("next-steps-mandatory");
        else nextStepsSection.classList.remove("next-steps-mandatory");
        return hasAtLeastOneStep;
    }

    function validateAllMandatoryFields() {
        const mandatoryFields = ["topic", "requestedBy", "decisionOwner", "background", "decisionRequired", "recommendation"];
        let isValid = true;
        mandatoryFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const fieldContainer = document.getElementById(fieldId + "Field");
            if (field && fieldContainer) {
                if (!field.value.trim()) {
                    fieldContainer.classList.add("mandatory-field");
                    isValid = false;
                } else {
                    fieldContainer.classList.remove("mandatory-field");
                }
            }
        });
        if (!validateNextSteps()) isValid = false;
        return isValid;
    }

    function checkSection7Complete() {
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        const decisionNotes = document.getElementById("decisionNotes").value.trim();
        return decisionSelected && decisionNotes.length > 0;
    }

    function checkDecisionMade() {
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        const decisionNotes = document.getElementById("decisionNotes").value.trim();
        const decisionMade = decisionSelected && decisionNotes.length > 0;
        const pdfBtn = document.getElementById("generatePdfBtn");
        
        // Only enable PDF button for manager when decision is made
        if (isManagerMode && decisionMade) {
            pdfBtn.disabled = false;
            pdfBtn.title = "Generate PDF document";
        } else if (!isManagerMode) {
            pdfBtn.disabled = true;
            pdfBtn.title = "Only manager can generate PDF after making decision";
        } else {
            pdfBtn.disabled = true;
            pdfBtn.title = "Please make a decision and add notes first";
        }
        
        return decisionMade;
    }

    function updateStatusBadge() {
        const statusBadge = document.getElementById("statusBadge");
        const decisionSelected = document.querySelector('input[name="decision"]:checked');
        if (!decisionSelected) {
            statusBadge.textContent = "Draft";
            statusBadge.className = "status-indicator";
            return;
        }
        switch (decisionSelected.value) {
            case "approved":
                statusBadge.textContent = "Approved";
                statusBadge.className = "status-indicator status-approved";
                break;
            case "approved-conditions":
                statusBadge.textContent = "Approved with Conditions";
                statusBadge.className = "status-indicator status-conditional";
                break;
            case "not-approved":
                statusBadge.textContent = "Not Approved";
                statusBadge.className = "status-indicator status-rejected";
                break;
            case "requester-promoted":
                statusBadge.textContent = "Requester to Decide";
                statusBadge.className = "status-indicator status-promoted";
                break;
            default:
                statusBadge.textContent = "Draft";
                statusBadge.className = "status-indicator";
        }
    }

    function resetForm() {
        if (!confirm("Reset all fields?")) return;
        document.querySelectorAll("input[type='text'], input[type='email'], textarea").forEach(el => el.value = "");
        document.querySelectorAll("input[type='radio'][name='decision']").forEach(r => r.checked = false);
        document.getElementById("requestDate").valueAsDate = new Date();
        document.getElementById("decisionDate").valueAsDate = new Date();
        documentUniqueId = null;
        generateDocumentId();
        document.getElementById("nextStepsSection").classList.remove("next-steps-mandatory");
        const mandatoryFields = ["topic", "requestedBy", "decisionOwner", "background", "decisionRequired", "recommendation"];
        mandatoryFields.forEach(fieldId => {
            const fieldContainer = document.getElementById(fieldId + "Field");
            if (fieldContainer) fieldContainer.classList.remove("mandatory-field");
        });
        document.querySelectorAll(".score-select").forEach(select => { select.value = "0"; });
        document.querySelectorAll(".option-card").forEach(card => calculateScore(card));
        
        // Reset document state
        documentSaved = false;
        isDocumentLoadedFromURL = false;
        enableRequesterMode();
        
        updateStatusBadge();
        checkDecisionMade();
        updateUIForRole();
    }

    function collectFormData() {
        const data = {};
        data.Topic = document.getElementById("topic").value;
        data.RequestedBy = document.getElementById("requestedBy").value;
        data.DecisionOwner = document.getElementById("decisionOwner").value;
        data.RequesterEmail = document.getElementById("requesterEmail").value || "";
        data.DecisionOwnerEmail = document.getElementById("decisionOwnerEmail").value || "";
        data.RequestDate = document.getElementById("requestDate").value;
        data.DecisionDate = document.getElementById("decisionDate").value;
        data.Background = document.getElementById("background").value;
        data.DecisionRequired = document.getElementById("decisionRequired").value;

        data.Options = [];
        document.querySelectorAll(".option-card").forEach(card => {
            const option = {
                Title: card.querySelector(".option-title").value,
                Description: card.querySelector(".option-description").value,
                Scores: []
            };
            const criteria = ["Cost", "Time", "Risk", "People", "Compliance"];
            card.querySelectorAll(".score-select").forEach((select, idx) => {
                option.Scores.push({
                    Criterion: criteria[idx],
                    Score: parseInt(select.value) || 0
                });
            });
            data.Options.push(option);
        });

        data.Documents = [];
        document.querySelectorAll(".document-input").forEach(input => {
            if (input.value.trim()) data.Documents.push(input.value.trim());
        });

        data.Recommendation = document.getElementById("recommendation").value;

        data.NextSteps = [];
        const stepActions = document.querySelectorAll(".step-action");
        const stepResponsibles = document.querySelectorAll(".step-responsible");
        const stepTimelines = document.querySelectorAll(".step-timeline");
        for (let i = 0; i < stepActions.length; i++) {
            if (stepActions[i].value.trim() || stepResponsibles[i].value.trim() || stepTimelines[i].value.trim()) {
                data.NextSteps.push({
                    Action: stepActions[i].value,
                    Responsible: stepResponsibles[i].value,
                    Timeline: stepTimelines[i].value
                });
            }
        }

        const selectedDecision = document.querySelector('input[name="decision"]:checked');
        data.Decision = selectedDecision ? selectedDecision.value : "";
        data.DecisionNotes = document.getElementById("decisionNotes").value;
        data.DocId = document.getElementById("docId").textContent;
        data.GeneratedDate = document.getElementById("generatedDate").textContent;
        data.DecisionStatusText = (function () {
            if (!selectedDecision) return "Pending";
            switch (selectedDecision.value) {
                case "approved": return "Approved";
                case "approved-conditions": return "Approved with conditions";
                case "not-approved": return "Not approved";
                case "requester-promoted": return "Requester to decide";
                default: return selectedDecision.value;
            }
        })();
        data.UserRole = currentUserRole;
        data.IsManagerMode = isManagerMode;
        return data;
    }

    function populateForm(data) {
        if (!data) return;
        if (data.Topic) document.getElementById("topic").value = data.Topic;
        if (data.RequestedBy) document.getElementById("requestedBy").value = data.RequestedBy;
        if (data.DecisionOwner) document.getElementById("decisionOwner").value = data.DecisionOwner;
        if (data.RequesterEmail) document.getElementById("requesterEmail").value = data.RequesterEmail;
        if (data.DecisionOwnerEmail) document.getElementById("decisionOwnerEmail").value = data.DecisionOwnerEmail;
        if (data.RequestDate) document.getElementById("requestDate").value = data.RequestDate;
        if (data.DecisionDate) document.getElementById("decisionDate").value = data.DecisionDate;
        if (data.Background) document.getElementById("background").value = data.Background;
        if (data.DecisionRequired) document.getElementById("decisionRequired").value = data.DecisionRequired;
        if (data.Recommendation) document.getElementById("recommendation").value = data.Recommendation;

        if (data.Options && data.Options.length > 0) {
            const optionCards = document.querySelectorAll(".option-card");
            data.Options.forEach((option, idx) => {
                if (optionCards[idx]) {
                    if (option.Title) optionCards[idx].querySelector(".option-title").value = option.Title;
                    if (option.Description) optionCards[idx].querySelector(".option-description").value = option.Description;
                    if (option.Scores && option.Scores.length > 0) {
                        const selects = optionCards[idx].querySelectorAll(".score-select");
                        option.Scores.forEach((scoreObj, sIdx) => {
                            if (selects[sIdx]) selects[sIdx].value = scoreObj.Score;
                        });
                    }
                    calculateScore(optionCards[idx]);
                }
            });
        }

        if (data.Documents && data.Documents.length > 0) {
            const docInputs = document.querySelectorAll(".document-input");
            data.Documents.forEach((doc, idx) => {
                if (docInputs[idx]) docInputs[idx].value = doc;
            });
        }

        if (data.NextSteps && data.NextSteps.length > 0) {
            const stepActions = document.querySelectorAll(".step-action");
            const stepResponsibles = document.querySelectorAll(".step-responsible");
            const stepTimelines = document.querySelectorAll(".step-timeline");
            data.NextSteps.forEach((step, idx) => {
                if (stepActions[idx]) stepActions[idx].value = step.Action || "";
                if (stepResponsibles[idx]) stepResponsibles[idx].value = step.Responsible || "";
                if (stepTimelines[idx]) stepTimelines[idx].value = step.Timeline || "";
            });
        }

        if (data.Decision) {
            const r = document.querySelector(`input[name="decision"][value="${data.Decision}"]`);
            if (r) r.checked = true;
        }
        if (data.DecisionNotes) document.getElementById("decisionNotes").value = data.DecisionNotes;
        if (data.DocId) document.getElementById("docId").textContent = data.DocId;

        // Apply user role based on loaded data
        applyUserRole();
        
        updateStatusBadge();
        checkDecisionMade();
        validateAllMandatoryFields();
        
        // Update document state
        documentSaved = true;
        updateUIForRole();
    }

    function showAlert(message, type = 'info') {
        const alert = document.createElement('div');
        alert.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            min-width: 250px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            word-wrap: break-word;
            white-space: pre-line;
        `;
        
        switch(type) {
            case 'success':
                alert.style.backgroundColor = '#10b981';
                alert.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 10px;"></i> ${message}`;
                break;
            case 'error':
                alert.style.backgroundColor = '#ef4444';
                alert.innerHTML = `<i class="fas fa-exclamation-circle" style="margin-right: 10px;"></i> ${message}`;
                break;
            case 'warning':
                alert.style.backgroundColor = '#f59e0b';
                alert.innerHTML = `<i class="fas fa-exclamation-triangle" style="margin-right: 10px;"></i> ${message}`;
                break;
            default:
                alert.style.backgroundColor = '#3b82f6';
                alert.innerHTML = `<i class="fas fa-info-circle" style="margin-right: 10px;"></i> ${message}`;
        }
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 5000);
    }
</script>
</body>
</html>